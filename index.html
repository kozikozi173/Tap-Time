<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TapTime - 時間管理アプリ</title>
    <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;TapTime&quot;,&quot;short_name&quot;:&quot;TapTime&quot;,&quot;description&quot;:&quot;タップするだけ、あなたの時間が見えてくる&quot;,&quot;start_url&quot;:&quot;/&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#ffffff&quot;,&quot;theme_color&quot;:&quot;#3b82f6&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233b82f6'/%3E%3Ctext x='50' y='60' text-anchor='middle' fill='white' font-size='30' font-family='Arial'%3E⏰%3C/text%3E%3C/svg%3E&quot;,&quot;sizes&quot;:&quot;192x192&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;}]}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="TapTime">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=Noto+Sans+JP:wght@300;400;500;600;700&family=M+PLUS+Rounded+1c:wght@400;700;900&family=Klee+One:wght@400;600&family=Noto+Serif+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Light Theme (Default) */
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-gradient-start: #eff6ff;
            --bg-gradient-end: #e0e7ff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            --border-color: #d1d5db;
            --shadow-color: rgba(0,0,0,0.1);
            --card-bg: #ffffff;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --overlay-bg: rgba(0,0,0,0.5);
            --font-family: 'Noto Sans JP', sans-serif;
        }

        [data-theme="pastel-pink"] {
            --bg-primary: #fef7f7;
            --bg-secondary: #fdf2f2;
            --bg-gradient-start: #fef7f7;
            --bg-gradient-end: #fce7e7;
            --text-primary: #7c2d2d;
            --text-secondary: #a85252;
            --text-muted: #d87979;
            --border-color: #f4c2c2;
            --shadow-color: rgba(220, 96, 96, 0.1);
            --card-bg: #ffffff;
            --accent-color: #dc6060;
            --accent-hover: #c55555;
            --success-color: #34d399;
            --danger-color: #f87171;
            --overlay-bg: rgba(220, 96, 96, 0.5);
        }

        [data-theme="pastel-blue"] {
            --bg-primary: #f0f9ff;
            --bg-secondary: #e0f4ff;
            --bg-gradient-start: #f0f9ff;
            --bg-gradient-end: #dbeafe;
            --text-primary: #1e3a8a;
            --text-secondary: #3b82f6;
            --text-muted: #60a5fa;
            --border-color: #bfdbfe;
            --shadow-color: rgba(59, 130, 246, 0.1);
            --card-bg: #ffffff;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --success-color: #34d399;
            --danger-color: #f87171;
            --overlay-bg: rgba(59, 130, 246, 0.5);
        }

        [data-theme="pastel-green"] {
            --bg-primary: #f0fdf4;
            --bg-secondary: #e7fced;
            --bg-gradient-start: #f0fdf4;
            --bg-gradient-end: #dcfce7;
            --text-primary: #166534;
            --text-secondary: #16a34a;
            --text-muted: #4ade80;
            --border-color: #bbf7d0;
            --shadow-color: rgba(34, 197, 94, 0.1);
            --card-bg: #ffffff;
            --accent-color: #22c55e;
            --accent-hover: #16a34a;
            --success-color: #10b981;
            --danger-color: #f87171;
            --overlay-bg: rgba(34, 197, 94, 0.5);
        }

        [data-theme="pastel-purple"] {
            --bg-primary: #fef7ff;
            --bg-secondary: #fdf4ff;
            --bg-gradient-start: #fef7ff;
            --bg-gradient-end: #f3e8ff;
            --text-primary: #5b21b6;
            --text-secondary: #7c3aed;
            --text-muted: #a855f7;
            --border-color: #e9d5ff;
            --shadow-color: rgba(139, 92, 246, 0.1);
            --card-bg: #ffffff;
            --accent-color: #8b5cf6;
            --accent-hover: #7c3aed;
            --success-color: #34d399;
            --danger-color: #f87171;
            --overlay-bg: rgba(139, 92, 246, 0.5);
        }

        [data-theme="pastel-orange"] {
            --bg-primary: #fff7ed;
            --bg-secondary: #ffedd5;
            --bg-gradient-start: #fff7ed;
            --bg-gradient-end: #fed7aa;
            --text-primary: #9a3412;
            --text-secondary: #c2410c;
            --text-muted: #fb923c;
            --border-color: #fdba74;
            --shadow-color: rgba(249, 115, 22, 0.1);
            --card-bg: #ffffff;
            --accent-color: #f97316;
            --accent-hover: #ea580c;
            --success-color: #34d399;
            --danger-color: #f87171;
            --overlay-bg: rgba(249, 115, 22, 0.5);
        }

        [data-theme="pastel-yellow"] {
            --bg-primary: #fffbeb;
            --bg-secondary: #fef3c7;
            --bg-gradient-start: #fffbeb;
            --bg-gradient-end: #fde68a;
            --text-primary: #92400e;
            --text-secondary: #d97706;
            --text-muted: #f59e0b;
            --border-color: #fde68a;
            --shadow-color: rgba(245, 158, 11, 0.1);
            --card-bg: #ffffff;
            --accent-color: #f59e0b;
            --accent-hover: #d97706;
            --success-color: #34d399;
            --danger-color: #f87171;
            --overlay-bg: rgba(245, 158, 11, 0.5);
        }

        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-gradient-start: #111827;
            --bg-gradient-end: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --border-color: #374151;
            --shadow-color: rgba(0,0,0,0.3);
            --card-bg: #1f2937;
            --accent-color: #60a5fa;
            --accent-hover: #3b82f6;
            --success-color: #34d399;
            --danger-color: #f87171;
            --overlay-bg: rgba(0,0,0,0.7);
        }

        /* Font variants */
        [data-font="cute"] { --font-family: 'Kosugi Maru', sans-serif; }
        [data-font="simple"] { --font-family: 'Noto Sans JP', sans-serif; }
        [data-font="bold"] { --font-family: 'M PLUS Rounded 1c', sans-serif; }
        [data-font="handwrite"] { --font-family: 'Klee One', cursive; }
        [data-font="serif"] { --font-family: 'Noto Serif JP', serif; }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding-bottom: 80px;
            color: var(--text-primary);
            transition: all 0.3s ease;
            position: relative;
        }

        /* Enhanced Background System */
        .background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .background-video {
            position: absolute;
            top: 50%;
            left: 50%;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            transform: translate(-50%, -50%);
            opacity: 0.6;
            object-fit: cover;
        }

        .background-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.6;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .background-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.8;
            background-size: cover;
            background-position: center;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 25px var(--shadow-color);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5rem;
            color: var(--text-primary);
            margin-bottom: 10px;
            font-weight: 800;
            background: linear-gradient(45deg, var(--accent-color), var(--success-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .timer-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 25px var(--shadow-color);
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
        }

        .timer-display {
            text-align: center;
            margin-bottom: 30px;
        }

        .elapsed-time {
            font-size: 3.5rem;
            font-family: var(--font-family);
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 15px;
            text-shadow: 0 2px 4px var(--shadow-color);
            transition: all 0.5s ease;
        }

        /* 没入モード - 非常にシンプルなアプローチ */
        body.immersive-mode #record-screen .header,
        body.immersive-mode #record-screen .category-select,
        body.immersive-mode #record-screen .main-button,
        body.immersive-mode #record-screen .recording-status,
        body.immersive-mode #record-screen .current-time {
            display: none !important;
        }

        body.immersive-mode #record-screen .timer-card {
            background: transparent !important;
            box-shadow: none !important;
            border: none !important;
        }

        body.immersive-mode #record-screen .timer-display {
            position: fixed !important;
            top: 50vh !important;
            left: 50% !important;
            transform: translateX(-50%) translateY(-55%) !important;
            z-index: 9999 !important;
            margin: 0 !important;
            width: 100vw !important;
            text-align: center !important;
        }

        body.immersive-mode #record-screen .elapsed-time {
            font-size: 5rem !important;
            color: rgba(255, 255, 255, 0.95) !important;
            text-shadow: 0 0 40px rgba(0, 0, 0, 0.9), 3px 3px 6px rgba(0, 0, 0, 0.8) !important;
            background: none !important;
            padding: 0 !important;
            border-radius: 0 !important;
            backdrop-filter: none !important;
            border: none !important;
            margin: 0 !important;
            display: block !important;
            box-shadow: none !important;
        }

        body.immersive-mode #record-screen .timer-card {
            background: none !important;
            box-shadow: none !important;
            border: none !important;
            backdrop-filter: none !important;
        }

        body.immersive-mode .navigation {
            display: none !important;
        }

        /* 没入モード用オーバーレイ */
        .immersive-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 5;
            cursor: pointer;
            display: none;
            background: transparent;
        }

        body.immersive-mode .immersive-overlay {
            display: block !important;
        }

        .current-time {
            font-size: 1.2rem;
            color: var(--text-secondary);
        }

        .category-select {
            margin-bottom: 30px;
        }

        .category-select label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .dropdown {
            position: relative;
            width: 100%;
        }

        .dropdown-button {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--card-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 1rem;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .dropdown-button:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .dropdown-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .dropdown-content {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 5px;
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            box-shadow: 0 10px 25px var(--shadow-color);
            z-index: 100;
            max-height: 240px;
            overflow-y: auto;
        }

        .dropdown-item {
            width: 100%;
            padding: 15px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: background 0.2s ease;
        }

        .dropdown-item:hover {
            background: var(--bg-secondary);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .color-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .main-button {
            width: 100%;
            padding: 20px;
            border: none;
            border-radius: 15px;
            font-size: 1.3rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            position: relative;
            overflow: hidden;
        }

        .main-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .main-button:hover::before {
            left: 100%;
        }

        .main-button.start {
            background: linear-gradient(45deg, var(--accent-color), var(--success-color));
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }

        .main-button.start:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(59, 130, 246, 0.4);
        }

        .main-button.stop {
            background: linear-gradient(45deg, var(--danger-color), #f97316);
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
        }

        .main-button.stop:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(239, 68, 68, 0.4);
        }

        .recording-status {
            margin-top: 15px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid var(--border-color);
        }

        .recording-status-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .navigation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            padding: 15px;
            backdrop-filter: blur(10px);
        }

        .nav-items {
            display: flex;
            justify-content: space-around;
            max-width: 480px;
            margin: 0 auto;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }

        .nav-item.active {
            color: var(--accent-color);
            background: var(--bg-secondary);
        }

        .nav-item:hover {
            color: var(--text-primary);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            font-size: 1.2rem;
        }

        .nav-label {
            font-size: 0.75rem;
            font-weight: 600;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .stats-screen, .settings-screen {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .screen-title {
            font-size: 2rem;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 30px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px var(--shadow-color);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .date-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 30px;
        }

        .date-nav button {
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .date-nav button:hover {
            background: var(--bg-secondary);
            transform: scale(1.05);
        }

        .date-nav button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .date-display {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stat-item {
            margin-bottom: 20px;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .stat-name {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stat-value {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .category-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .category-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .category-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .category-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 8px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 5px;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: var(--border-color);
            transform: scale(1.1);
        }

        .add-btn, .export-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .add-btn {
            background: linear-gradient(45deg, var(--accent-color), var(--success-color));
            color: white;
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }

        .export-btn {
            background: linear-gradient(45deg, var(--success-color), #06b6d4);
            color: white;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
        }

        /* Enhanced Theme Selector */
        .theme-selector {
            margin-bottom: 20px;
        }

        .theme-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .theme-option {
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            background: var(--card-bg);
        }

        .theme-option.active {
            border-color: var(--accent-color);
            background: var(--bg-secondary);
            transform: scale(1.05);
        }

        .theme-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--shadow-color);
        }

        .theme-preview {
            width: 100%;
            height: 40px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            overflow: hidden;
        }

        .theme-preview .color {
            flex: 1;
            height: 100%;
        }

        .theme-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        /* Font Selector */
        .font-selector {
            margin-bottom: 20px;
        }

        .font-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .font-option {
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            background: var(--card-bg);
        }

        .font-option.active {
            border-color: var(--accent-color);
            background: var(--bg-secondary);
        }

        .font-option:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px var(--shadow-color);
        }

        .font-sample {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .font-name {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Background Selector */
        .background-selector {
            margin-bottom: 20px;
        }

        .background-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .background-option {
            position: relative;
            aspect-ratio: 16/9;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .background-option.active {
            border-color: var(--accent-color);
            transform: scale(1.05);
        }

        .background-option:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px var(--shadow-color);
        }

        .background-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .background-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px;
            text-align: center;
            font-size: 0.7rem;
            font-weight: 500;
        }

        /* File Input for Custom Media */
        .file-input-container {
            margin-top: 15px;
            padding: 15px;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .file-input-container:hover {
            border-color: var(--accent-color);
            background: var(--bg-secondary);
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--overlay-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 40px var(--shadow-color);
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 25px;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--card-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .color-section {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .color-picker {
            width: 60px;
            height: 60px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            background: var(--card-bg);
        }

        .color-input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
        }

        .color-swatch {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .color-swatch:hover {
            transform: scale(1.1);
        }

        .color-swatch.selected {
            border-color: var(--text-primary);
            border-width: 3px;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--accent-color), var(--success-color));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .hidden {
            display: none !important;
        }

        .no-records {
            text-align: center;
            color: var(--text-muted);
            padding: 40px 20px;
        }

        .record-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
        }

        .record-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .record-details {
            flex: 1;
        }

        .record-category {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .record-time {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .record-duration {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Animations */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .floating {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 0.6; }
        }

        .background-container.active {
            animation: pulse 4s ease-in-out infinite;
        }

        /* PWA specific styles */
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: calc(80px + env(safe-area-inset-bottom));
            }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .stats-screen .card {
                grid-column: 1;
            }
            
            .container {
                padding: 15px;
            }
            
            .theme-options {
                grid-template-columns: 1fr 1fr;
            }

            .font-options {
                grid-template-columns: 1fr;
            }

            .background-options {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body data-theme="light" data-font="cute">
    <div class="background-container" id="background-container">
        <!-- Dynamic background content will be inserted here -->
    </div>
    
    <div id="app">
        <!-- 記録画面 -->
        <div id="record-screen" class="screen active">
            <div class="container">
                <div class="header floating">
                    <h1>TapTime</h1>
                    <p>タップするだけ、あなたの時間が見えてくる</p>
                </div>

                <div class="timer-card">
                    <div class="timer-display">
                        <div id="elapsed-time" class="elapsed-time">00:00:00</div>
                        <div id="current-time" class="current-time"></div>
                    </div>

                    <div class="category-select">
                        <label>カテゴリ選択</label>
                        <div class="dropdown">
                            <button id="category-dropdown-btn" class="dropdown-button">
                                <div id="selected-category">
                                    <span class="color-dot" style="background-color: #3b82f6;"></span>
                                    <span>勉強</span>
                                </div>
                                <span>▼</span>
                            </button>
                            <div id="category-dropdown" class="dropdown-content hidden">
                                <!-- カテゴリオプションがここに動的に追加される -->
                            </div>
                        </div>
                    </div>

                    <button id="main-button" class="main-button start">
                        <span>▶</span>
                        <span>開始</span>
                    </button>

                    <div id="recording-status" class="recording-status hidden">
                        <span class="color-dot" style="background-color: #3b82f6;"></span>
                        <span class="recording-status-text">勉強 を記録中...</span>
                    </div>
                </div>

                <!-- Immersive mode overlay -->
                <div class="immersive-overlay" id="immersive-overlay"></div>
            </div>
        </div>

        <!-- 統計画面 -->
        <div id="stats-screen" class="screen">
            <div class="stats-screen">
                <div class="date-nav">
                    <h2 class="screen-title">統計</h2>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <button id="prev-day">←</button>
                        <div id="view-date" class="date-display"></div>
                        <button id="next-day">→</button>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr; gap: 20px;">
                    <div class="card">
                        <h3 class="card-title">カテゴリ別時間</h3>
                        <div id="category-stats">
                            <div class="no-records">この日の記録はありません</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">記録一覧</h3>
                        <div id="record-list" class="record-list">
                            <div class="no-records">この日の記録はありません</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 設定画面 -->
        <div id="settings-screen" class="screen">
            <div class="settings-screen">
                <h2 class="screen-title">設定</h2>

                <!-- テーマ設定 -->
                <div class="card">
                    <h3 class="card-title">外観設定</h3>
                    
                    <div class="theme-selector">
                        <label class="form-label">カラーテーマ</label>
                        <div class="theme-options">
                            <div class="theme-option active" data-theme="light">
                                <div class="theme-preview">
                                    <div class="color" style="background: #eff6ff;"></div>
                                    <div class="color" style="background: #3b82f6;"></div>
                                    <div class="color" style="background: #ffffff;"></div>
                                </div>
                                <div class="theme-name">ライト</div>
                            </div>
                            
                            <div class="theme-option" data-theme="dark">
                                <div class="theme-preview">
                                    <div class="color" style="background: #111827;"></div>
                                    <div class="color" style="background: #60a5fa;"></div>
                                    <div class="color" style="background: #1f2937;"></div>
                                </div>
                                <div class="theme-name">ダーク</div>
                            </div>
                            
                            <div class="theme-option" data-theme="pastel-pink">
                                <div class="theme-preview">
                                    <div class="color" style="background: #fef7f7;"></div>
                                    <div class="color" style="background: #dc6060;"></div>
                                    <div class="color" style="background: #fce7e7;"></div>
                                </div>
                                <div class="theme-name">パステルピンク</div>
                            </div>

                            <div class="theme-option" data-theme="pastel-blue">
                                <div class="theme-preview">
                                    <div class="color" style="background: #f0f9ff;"></div>
                                    <div class="color" style="background: #3b82f6;"></div>
                                    <div class="color" style="background: #dbeafe;"></div>
                                </div>
                                <div class="theme-name">パステルブルー</div>
                            </div>

                            <div class="theme-option" data-theme="pastel-green">
                                <div class="theme-preview">
                                    <div class="color" style="background: #f0fdf4;"></div>
                                    <div class="color" style="background: #22c55e;"></div>
                                    <div class="color" style="background: #dcfce7;"></div>
                                </div>
                                <div class="theme-name">パステルグリーン</div>
                            </div>

                            <div class="theme-option" data-theme="pastel-purple">
                                <div class="theme-preview">
                                    <div class="color" style="background: #fef7ff;"></div>
                                    <div class="color" style="background: #8b5cf6;"></div>
                                    <div class="color" style="background: #f3e8ff;"></div>
                                </div>
                                <div class="theme-name">パステルパープル</div>
                            </div>

                            <div class="theme-option" data-theme="pastel-orange">
                                <div class="theme-preview">
                                    <div class="color" style="background: #fff7ed;"></div>
                                    <div class="color" style="background: #f97316;"></div>
                                    <div class="color" style="background: #fed7aa;"></div>
                                </div>
                                <div class="theme-name">パステルオレンジ</div>
                            </div>
                            <div class="theme-option" data-theme="pastel-yellow">
                                <div class="theme-preview">
                                    <div class="color" style="background: #fffbeb;"></div>
                                    <div class="color" style="background: #f59e0b;"></div>
                                    <div class="color" style="background: #fde68a;"></div>
                                </div>
                                <div class="theme-name">パステルイエロー</div>
                            </div>
                        </div>
                    </div>

                    <div class="font-selector">
                        <label class="form-label">フォント</label>
                        <div class="font-options">
                            <div class="font-option active" data-font="cute">
                                <div class="font-sample" style="font-family: 'Kosugi Maru', sans-serif;">時間を計る</div>
                                <div class="font-name">かわいい系</div>
                            </div>
                            <div class="font-option" data-font="simple">
                                <div class="font-sample" style="font-family: 'Noto Sans JP', sans-serif;">時間を計る</div>
                                <div class="font-name">シンプル</div>
                            </div>
                            <div class="font-option" data-font="bold">
                                <div class="font-sample" style="font-family: 'M PLUS Rounded 1c', sans-serif; font-weight: 900;">時間を計る</div>
                                <div class="font-name">太い</div>
                            </div>
                            <div class="font-option" data-font="handwrite">
                                <div class="font-sample" style="font-family: 'Klee One', cursive;">時間を計る</div>
                                <div class="font-name">手書き風</div>
                            </div>
                            <div class="font-option" data-font="serif">
                                <div class="font-sample" style="font-family: 'Noto Serif JP', serif;">時間を計る</div>
                                <div class="font-name">明朝</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 背景設定 -->
                <div class="card">
                    <h3 class="card-title">背景設定</h3>
                    
                    <div class="background-selector">
                        <label class="form-label">背景を選択</label>
                        <div class="background-options" id="background-options">
                            <div class="background-option active" data-bg="none">
                                <div class="background-preview" style="background: linear-gradient(45deg, #f0f9ff, #e0e7ff);"></div>
                                <div class="background-label">なし</div>
                            </div>
                        </div>
                        
                        <div class="file-input-container">
                            <input type="file" id="custom-background" class="file-input" accept="video/*,image/*,.gif">
                            <label for="custom-background" class="file-input-label">
                                📁 カスタム背景をアップロード<br>
                                <small>動画、画像、GIFファイルに対応</small>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- カテゴリ管理 -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 class="card-title" style="margin-bottom: 0;">カテゴリ管理</h3>
                        <button id="add-category-btn" class="add-btn">
                            <span>+</span>
                            <span>追加</span>
                        </button>
                    </div>
                    <div id="category-list" class="category-list">
                        <!-- カテゴリがここに動的に追加される -->
                    </div>
                </div>

                <!-- データ管理 -->
                <div class="card">
                    <h3 class="card-title">データ</h3>
                    <button id="export-btn" class="export-btn">
                        <span>📥</span>
                        <span>CSVエクスポート</span>
                    </button>
                    <p style="margin-top: 10px; font-size: 0.9rem; color: var(--text-secondary);">
                        記録データをCSVファイルとしてダウンロードします
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- ナビゲーション -->
    <div class="navigation">
        <div class="nav-items">
            <button class="nav-item active" data-screen="record">
                <div class="nav-icon">⏱️</div>
                <div class="nav-label">記録</div>
            </button>
            <button class="nav-item" data-screen="stats">
                <div class="nav-icon">📊</div>
                <div class="nav-label">統計</div>
            </button>
            <button class="nav-item" data-screen="settings">
                <div class="nav-icon">⚙️</div>
                <div class="nav-label">設定</div>
            </button>
        </div>
    </div>

    <!-- モーダル -->
    <div id="category-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="modal-title">カテゴリ追加</h3>
            
            <div class="form-group">
                <label class="form-label">カテゴリ名</label>
                <input type="text" id="category-name-input" class="form-input" placeholder="カテゴリ名を入力">
            </div>

            <div class="form-group">
                <label class="form-label">カラー</label>
                <div class="color-section">
                    <input type="color" id="color-picker" class="color-picker" value="#3b82f6">
                    <input type="text" id="color-input" class="color-input" value="#3b82f6" placeholder="#3b82f6">
                </div>
                <div class="color-palette" id="color-palette">
                    <!-- プリセットカラーがここに追加される -->
                </div>
            </div>

            <div class="modal-buttons">
                <button id="cancel-btn" class="btn btn-secondary">キャンセル</button>
                <button id="save-btn" class="btn btn-primary">追加</button>
            </div>
        </div>
    </div>

    <script>
        // アプリケーションの状態
        let appState = {
            currentTime: new Date(),
            isRecording: false,
            recordingStart: null,
            elapsedTime: 0,
            selectedCategory: 1,
            activeScreen: 'record',
            categories: [
                { id: 1, name: '勉強', color: '#3b82f6' },
                { id: 2, name: '仕事', color: '#10b981' },
                { id: 3, name: '読書', color: '#8b5cf6' },
                { id: 4, name: '運動', color: '#f59e0b' }
            ],
            records: [],
            viewDate: new Date(),
            editingCategory: null,
            currentTheme: localStorage.getItem('taptime-theme') || 'light',
            currentFont: localStorage.getItem('taptime-font') || 'cute',
            currentBackground: localStorage.getItem('taptime-background') || 'none',
            customBackgrounds: JSON.parse(localStorage.getItem('taptime-custom-backgrounds') || '[]'),
            immersiveTimeout: null
        };

        // プリセットカラー
        const presetColors = [
            '#3b82f6', '#10b981', '#8b5cf6', '#f59e0b',
            '#ef4444', '#06b6d4', '#84cc16', '#f97316',
            '#ec4899', '#6366f1', '#14b8a6', '#eab308',
            '#dc2626', '#0891b2', '#65a30d', '#ea580c'
        ];

        // プリセット背景
        const presetBackgrounds = [
            {
                id: 'lofi-study-1',
                name: 'LoFi勉強部屋',
                type: 'image',
                url: './lofi-study-1.gif'
            },
            {
                id: 'lofi-night-room',
                name: 'LoFi夜の部屋',
                type: 'image', 
                url: './lofi-night-room.gif'
            },
            {
                id: 'lofi-cyber-room',
                name: 'LoFiサイバー部屋', 
                type: 'image',
                url: './lofi-cyber-room.gif'
            }
        ];

        // テーマ設定の保存と適用
        function setTheme(theme) {
            appState.currentTheme = theme;
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('taptime-theme', theme);
            
            // テーマオプションの表示更新
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.toggle('active', option.dataset.theme === theme);
            });
        }

        // フォント設定の保存と適用
        function setFont(font) {
            appState.currentFont = font;
            document.body.setAttribute('data-font', font);
            localStorage.setItem('taptime-font', font);
            
            // フォントオプションの表示更新
            document.querySelectorAll('.font-option').forEach(option => {
                option.classList.toggle('active', option.dataset.font === font);
            });
        }

        // 背景設定の保存と適用
        function setBackground(backgroundId) {
            appState.currentBackground = backgroundId;
            localStorage.setItem('taptime-background', backgroundId);
            
            const container = document.getElementById('background-container');
            container.innerHTML = '';
            
            if (backgroundId === 'none') {
                container.classList.remove('active');
                return;
            }
            
            // カスタム背景の確認
            const customBg = appState.customBackgrounds.find(bg => bg.id === backgroundId);
            if (customBg) {
                if (customBg.type === 'video') {
                    const video = document.createElement('video');
                    video.className = 'background-video';
                    video.src = customBg.url;
                    video.autoplay = true;
                    video.loop = true;
                    video.muted = true;
                    video.playsInline = true;
                    container.appendChild(video);
                } else {
                    const img = document.createElement('div');
                    img.className = 'background-image';
                    img.style.backgroundImage = `url(${customBg.url})`;
                    container.appendChild(img);
                }
            } else {
                // プリセット背景
                const presetBg = presetBackgrounds.find(bg => bg.id === backgroundId);
                if (presetBg) {
                    const bgElement = document.createElement('div');
                    bgElement.className = 'background-svg';
                    bgElement.style.backgroundImage = `url('${presetBg.url}')`;
                    container.appendChild(bgElement);
                }
            }
            
            container.classList.add('active');
            
            // 背景オプションの表示更新
            document.querySelectorAll('.background-option').forEach(option => {
                option.classList.toggle('active', option.dataset.bg === backgroundId);
            });
        }

        // カスタム背景の追加
        function addCustomBackground(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const customBg = {
                    id: 'custom-' + Date.now(),
                    name: file.name,
                    type: file.type.startsWith('video/') ? 'video' : 'image',
                    url: e.target.result
                };
                
                appState.customBackgrounds.push(customBg);
                localStorage.setItem('taptime-custom-backgrounds', JSON.stringify(appState.customBackgrounds));
                
                updateBackgroundOptions();
                setBackground(customBg.id);
            };
            reader.readAsDataURL(file);
        }

        // 背景オプションの更新
        function updateBackgroundOptions() {
            const container = document.getElementById('background-options');
            let html = `
                <div class="background-option ${appState.currentBackground === 'none' ? 'active' : ''}" data-bg="none">
                    <div class="background-preview" style="background: linear-gradient(45deg, #f0f9ff, #e0e7ff);"></div>
                    <div class="background-label">なし</div>
                </div>
            `;
            
            // プリセット背景を追加
            presetBackgrounds.forEach(bg => {
                const isActive = appState.currentBackground === bg.id;
                html += `
                    <div class="background-option ${isActive ? 'active' : ''}" data-bg="${bg.id}">
                        <div class="background-preview" style="background-image: url('${bg.url}'); background-size: cover; background-position: center;"></div>
                        <div class="background-label">${bg.name}</div>
                    </div>
                `;
            });
            
            // カスタム背景を追加
            appState.customBackgrounds.forEach(bg => {
                const isActive = appState.currentBackground === bg.id;
                html += `
                    <div class="background-option ${isActive ? 'active' : ''}" data-bg="${bg.id}">
                        <div class="background-preview" style="background-image: url('${bg.url}'); background-size: cover; background-position: center;"></div>
                        <div class="background-label">${bg.name}</div>
                        <button class="action-btn" style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.5); color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px;" onclick="removeCustomBackground('${bg.id}')">×</button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // イベントリスナーを追加
            container.querySelectorAll('.background-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('action-btn')) {
                        setBackground(option.dataset.bg);
                    }
                });
            });
        }

        // 没入モードの制御 - 最もシンプルな方法
        function enterImmersiveMode() {
            document.body.classList.add('immersive-mode');
            document.getElementById('immersive-overlay').style.display = 'block';
            console.log('没入モード ON - bodyにクラス追加');
        }

        function exitImmersiveMode() {
            document.body.classList.remove('immersive-mode');
            document.getElementById('immersive-overlay').style.display = 'none';
            console.log('没入モード OFF - bodyからクラス削除');
        }

        // 没入モードタイマーの設定
        function setImmersiveTimer() {
            if (appState.immersiveTimeout) {
                clearTimeout(appState.immersiveTimeout);
            }
            
            if (appState.isRecording && appState.activeScreen === 'record') {
                console.log('Setting immersive timer for 5 seconds');
                appState.immersiveTimeout = setTimeout(() => {
                    if (appState.isRecording && appState.activeScreen === 'record') {
                        console.log('Entering immersive mode after 5 seconds');
                        enterImmersiveMode();
                    }
                }, 5000); // 5秒後に没入モード
            }
        }

        // 没入モードタイマーのクリア
        function clearImmersiveTimer() {
            if (appState.immersiveTimeout) {
                clearTimeout(appState.immersiveTimeout);
                appState.immersiveTimeout = null;
            }
            exitImmersiveMode();
        }

        // ページの表示状態変更を監視
        function handleVisibilityChange() {
            if (document.hidden) {
                // タブが非表示になった時
                console.log('タブが非表示になりました');
                if (appState.immersiveTimeout) {
                    clearTimeout(appState.immersiveTimeout);
                    appState.immersiveTimeout = null;
                }
                exitImmersiveMode();
            } else {
                // タブが表示状態に戻った時
                console.log('タブが表示状態に戻りました');
                // タブ復帰時は没入モードに入らない（手動操作を待つ）
                console.log('タブ復帰時は没入モードタイマーを設定しません');
            }
        }
        // カスタム背景の削除
        function removeCustomBackground(bgId) {
            if (confirm('この背景を削除しますか？')) {
                appState.customBackgrounds = appState.customBackgrounds.filter(bg => bg.id !== bgId);
                localStorage.setItem('taptime-custom-backgrounds', JSON.stringify(appState.customBackgrounds));
                
                if (appState.currentBackground === bgId) {
                    setBackground('none');
                }
                
                updateBackgroundOptions();
            }
        }

        // ユーティリティ関数
        function formatTime(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            return `${hours.toString().padStart(2, '0')}:${(minutes % 60).toString().padStart(2, '0')}:${(seconds % 60).toString().padStart(2, '0')}`;
        }

        function getCategoryById(id) {
            return appState.categories.find(cat => cat.id === id);
        }

        function updateCurrentTime() {
            appState.currentTime = new Date();
            document.getElementById('current-time').textContent = appState.currentTime.toLocaleTimeString('ja-JP');
            
            if (appState.isRecording && appState.recordingStart) {
                appState.elapsedTime = Date.now() - appState.recordingStart;
                document.getElementById('elapsed-time').textContent = formatTime(appState.elapsedTime);
            }
        }

        function updateCategoryDropdown() {
            const dropdown = document.getElementById('category-dropdown');
            const selectedDisplay = document.getElementById('selected-category');
            
            // 選択中のカテゴリ表示を更新
            const selectedCategory = getCategoryById(appState.selectedCategory);
            if (selectedCategory) {
                selectedDisplay.innerHTML = `
                    <span class="color-dot" style="background-color: ${selectedCategory.color};"></span>
                    <span>${selectedCategory.name}</span>
                `;
            }

            // ドロップダウンオプションを更新
            dropdown.innerHTML = '';
            appState.categories.forEach(category => {
                const item = document.createElement('button');
                item.className = 'dropdown-item';
                item.innerHTML = `
                    <span class="color-dot" style="background-color: ${category.color};"></span>
                    <span>${category.name}</span>
                `;
                item.addEventListener('click', () => {
                    appState.selectedCategory = category.id;
                    updateCategoryDropdown();
                    updateRecordingStatus();
                    dropdown.classList.add('hidden');
                });
                dropdown.appendChild(item);
            });
        }

        function updateRecordingStatus() {
            const status = document.getElementById('recording-status');
            const mainButton = document.getElementById('main-button');
            const dropdownBtn = document.getElementById('category-dropdown-btn');
            
            if (appState.isRecording) {
                const category = getCategoryById(appState.selectedCategory);
                status.innerHTML = `
                    <span class="color-dot" style="background-color: ${category.color};"></span>
                    <span class="recording-status-text">${category.name} を記録中...</span>
                `;
                status.classList.remove('hidden');
                mainButton.className = 'main-button stop';
                mainButton.innerHTML = '<span>⏸</span><span>停止</span>';
                dropdownBtn.disabled = true;
            } else {
                status.classList.add('hidden');
                mainButton.className = 'main-button start';
                mainButton.innerHTML = '<span>▶</span><span>開始</span>';
                dropdownBtn.disabled = false;
            }
        }

        function toggleRecording() {
            if (!appState.selectedCategory) {
                alert('カテゴリを選択してください');
                return;
            }

            if (appState.isRecording) {
                // 記録停止
                const endTime = Date.now();
                const duration = endTime - appState.recordingStart;
                const newRecord = {
                    id: Date.now(),
                    categoryId: appState.selectedCategory,
                    startTime: appState.recordingStart,
                    endTime: endTime,
                    duration: duration,
                    date: new Date(appState.recordingStart).toDateString()
                };
                appState.records.push(newRecord);
                appState.isRecording = false;
                appState.recordingStart = null;
                appState.elapsedTime = 0;
                document.getElementById('elapsed-time').textContent = '00:00:00';
                
                // 没入モードを終了
                clearImmersiveTimer();
            } else {
                // 記録開始
                appState.recordingStart = Date.now();
                appState.isRecording = true;
                appState.elapsedTime = 0;
                
                // 5秒後に没入モードに入るタイマーを設定
                setImmersiveTimer();
            }
            
            updateRecordingStatus();
        }

        function switchScreen(screenName) {
            // 全画面を非表示
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // ナビゲーションアイテムの状態更新
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 選択された画面を表示
            document.getElementById(`${screenName}-screen`).classList.add('active');
            document.querySelector(`[data-screen="${screenName}"]`).classList.add('active');
            
            appState.activeScreen = screenName;
            
            // 画面切り替え時に没入モードを終了
            if (screenName !== 'record') {
                clearImmersiveTimer();
            } else if (screenName === 'record') {
                // 記録画面に戻った時、記録中なら5秒後に没入モード
                if (appState.isRecording) {
                    console.log('記録画面に戻りました。記録中なので5秒後に没入モードに入ります');
                    setImmersiveTimer();
                }
            }
            
            // 画面固有の更新処理
            if (screenName === 'stats') {
                updateStatsScreen();
            } else if (screenName === 'settings') {
                updateSettingsScreen();
            }
        }

        function updateStatsScreen() {
            document.getElementById('view-date').textContent = appState.viewDate.toLocaleDateString('ja-JP');
            
            const dateStr = appState.viewDate.toDateString();
            const dayRecords = appState.records.filter(record => record.date === dateStr);
            
            // カテゴリ別統計
            const categoryStats = {};
            let totalTime = 0;
            
            dayRecords.forEach(record => {
                const category = getCategoryById(record.categoryId);
                if (category) {
                    if (!categoryStats[category.name]) {
                        categoryStats[category.name] = { time: 0, color: category.color };
                    }
                    categoryStats[category.name].time += record.duration;
                    totalTime += record.duration;
                }
            });
            
            // 統計表示
            const statsContainer = document.getElementById('category-stats');
            if (Object.keys(categoryStats).length === 0) {
                statsContainer.innerHTML = '<div class="no-records">この日の記録はありません</div>';
            } else {
                let html = '';
                Object.entries(categoryStats).forEach(([name, data]) => {
                    const percentage = totalTime > 0 ? (data.time / totalTime * 100) : 0;
                    html += `
                        <div class="stat-item">
                            <div class="stat-header">
                                <div class="stat-name">
                                    <span class="color-dot" style="background-color: ${data.color};"></span>
                                    <span>${name}</span>
                                </div>
                                <div class="stat-value">${formatTime(data.time)} (${percentage.toFixed(1)}%)</div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="background-color: ${data.color}; width: ${percentage}%;"></div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                    <div style="padding-top: 20px; border-top: 1px solid var(--border-color); margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; font-weight: bold;">
                            <span>合計時間</span>
                            <span>${formatTime(totalTime)}</span>
                        </div>
                    </div>
                `;
                statsContainer.innerHTML = html;
            }
            
            // 記録一覧
            const recordList = document.getElementById('record-list');
            if (dayRecords.length === 0) {
                recordList.innerHTML = '<div class="no-records">この日の記録はありません</div>';
            } else {
                let html = '';
                dayRecords.sort((a, b) => b.startTime - a.startTime).forEach(record => {
                    const category = getCategoryById(record.categoryId);
                    html += `
                        <div class="record-item">
                            <div class="record-info">
                                <span class="color-dot" style="background-color: ${category.color};"></span>
                                <div class="record-details">
                                    <div class="record-category">${category.name}</div>
                                    <div class="record-time">
                                        ${new Date(record.startTime).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })} - 
                                        ${new Date(record.endTime).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })}
                                    </div>
                                </div>
                            </div>
                            <div class="record-duration">${formatTime(record.duration)}</div>
                        </div>
                    `;
                });
                recordList.innerHTML = html;
            }
            
            // 次の日ボタンの状態
            const today = new Date().toDateString();
            document.getElementById('next-day').disabled = appState.viewDate.toDateString() === today;
        }

        function updateSettingsScreen() {
            const categoryList = document.getElementById('category-list');
            let html = '';
            
            appState.categories.forEach(category => {
                html += `
                    <div class="category-item">
                        <div class="category-info">
                            <span class="color-dot" style="background-color: ${category.color};"></span>
                            <span class="category-name">${category.name}</span>
                        </div>
                        <div class="category-actions">
                            <button class="action-btn" onclick="editCategory(${category.id})">✏️</button>
                            <button class="action-btn" onclick="deleteCategory(${category.id})" ${appState.categories.length <= 1 ? 'disabled' : ''}>🗑️</button>
                        </div>
                    </div>
                `;
            });
            
            categoryList.innerHTML = html;
            updateBackgroundOptions();
        }

        function openModal(isEdit = false, category = null) {
            const modal = document.getElementById('category-modal');
            const title = document.getElementById('modal-title');
            const nameInput = document.getElementById('category-name-input');
            const colorPicker = document.getElementById('color-picker');
            const colorInput = document.getElementById('color-input');
            const saveBtn = document.getElementById('save-btn');
            
            appState.editingCategory = category;
            
            if (isEdit && category) {
                title.textContent = 'カテゴリ編集';
                nameInput.value = category.name;
                colorPicker.value = category.color;
                colorInput.value = category.color;
                saveBtn.textContent = '更新';
            } else {
                title.textContent = 'カテゴリ追加';
                nameInput.value = '';
                colorPicker.value = '#3b82f6';
                colorInput.value = '#3b82f6';
                saveBtn.textContent = '追加';
            }
            
            updateColorPalette();
            modal.classList.remove('hidden');
            nameInput.focus();
        }

        function closeModal() {
            document.getElementById('category-modal').classList.add('hidden');
            appState.editingCategory = null;
        }

        function updateColorPalette() {
            const palette = document.getElementById('color-palette');
            const currentColor = document.getElementById('color-picker').value;
            
            let html = '';
            presetColors.forEach(color => {
                const selected = color === currentColor ? 'selected' : '';
                html += `<div class="color-swatch ${selected}" style="background-color: ${color};" onclick="selectColor('${color}')"></div>`;
            });
            palette.innerHTML = html;
        }

        function selectColor(color) {
            document.getElementById('color-picker').value = color;
            document.getElementById('color-input').value = color;
            updateColorPalette();
        }

        function saveCategory() {
            const nameInput = document.getElementById('category-name-input');
            const colorInput = document.getElementById('color-input');
            
            const name = nameInput.value.trim();
            const color = colorInput.value;
            
            if (!name) {
                alert('カテゴリ名を入力してください');
                return;
            }
            
            if (appState.editingCategory) {
                // 編集
                const index = appState.categories.findIndex(cat => cat.id === appState.editingCategory.id);
                if (index !== -1) {
                    appState.categories[index] = { ...appState.categories[index], name, color };
                }
            } else {
                // 新規追加
                const newCategory = {
                    id: Date.now(),
                    name,
                    color
                };
                appState.categories.push(newCategory);
            }
            
            updateCategoryDropdown();
            updateSettingsScreen();
            closeModal();
        }

        function editCategory(id) {
            const category = getCategoryById(id);
            if (category) {
                openModal(true, category);
            }
        }

        function deleteCategory(id) {
            if (appState.categories.length <= 1) {
                alert('最低1つのカテゴリが必要です');
                return;
            }
            
            if (confirm('このカテゴリを削除しますか？')) {
                appState.categories = appState.categories.filter(cat => cat.id !== id);
                
                // 選択中のカテゴリが削除された場合、最初のカテゴリを選択
                if (appState.selectedCategory === id) {
                    appState.selectedCategory = appState.categories[0].id;
                }
                
                updateCategoryDropdown();
                updateSettingsScreen();
            }
        }

        function exportData() {
            if (appState.records.length === 0) {
                alert('エクスポートするデータがありません');
                return;
            }
            
            const headers = ['日付', 'カテゴリ', '開始時間', '終了時間', '時間(分)'];
            const rows = appState.records.map(record => {
                const category = getCategoryById(record.categoryId);
                return [
                    new Date(record.startTime).toLocaleDateString('ja-JP'),
                    category?.name || 'Unknown',
                    new Date(record.startTime).toLocaleTimeString('ja-JP'),
                    new Date(record.endTime).toLocaleTimeString('ja-JP'),
                    Math.round(record.duration / 60000)
                ];
            });
            
            const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'taptime_data.csv';
            link.click();
        }

        // イベントリスナーの設定
        function setupEventListeners() {
            // タイマー更新
            setInterval(updateCurrentTime, 1000);
            
            // メインボタン
            document.getElementById('main-button').addEventListener('click', toggleRecording);
            
            // カテゴリドロップダウン
            document.getElementById('category-dropdown-btn').addEventListener('click', () => {
                const dropdown = document.getElementById('category-dropdown');
                dropdown.classList.toggle('hidden');
            });
            
            // ドロップダウン外クリックで閉じる
            document.addEventListener('click', (e) => {
                const dropdown = document.getElementById('category-dropdown');
                const dropdownBtn = document.getElementById('category-dropdown-btn');
                if (!dropdown.contains(e.target) && !dropdownBtn.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });
            
            // ナビゲーション
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const screen = item.dataset.screen;
                    switchScreen(screen);
                });
            });
            
            // 統計画面の日付ナビゲーション
            document.getElementById('prev-day').addEventListener('click', () => {
                appState.viewDate = new Date(appState.viewDate.getTime() - 24*60*60*1000);
                updateStatsScreen();
            });
            
            document.getElementById('next-day').addEventListener('click', () => {
                const tomorrow = new Date(appState.viewDate.getTime() + 24*60*60*1000);
                if (tomorrow.toDateString() <= new Date().toDateString()) {
                    appState.viewDate = tomorrow;
                    updateStatsScreen();
                }
            });
            
            // テーマ選択
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', () => {
                    setTheme(option.dataset.theme);
                });
            });

            // フォント選択
            document.querySelectorAll('.font-option').forEach(option => {
                option.addEventListener('click', () => {
                    setFont(option.dataset.font);
                });
            });

            // カスタム背景ファイル選択
            document.getElementById('custom-background').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    addCustomBackground(file);
                }
            });

            // 没入モードオーバーレイクリック
            document.getElementById('immersive-overlay').addEventListener('click', (e) => {
                console.log('オーバーレイがクリックされました');
                exitImmersiveMode();
                if (appState.isRecording) {
                    console.log('5秒後に再び没入モードに入ります');
                    setImmersiveTimer();
                }
            });
            
            // ページの表示状態変更を監視（タブ切り替え対応）
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            // 画面全体のクリックで没入モード終了
            document.addEventListener('click', (e) => {
                if (document.body.classList.contains('immersive-mode')) {
                    console.log('没入モード中にクリックされました');
                    exitImmersiveMode();
                    if (appState.isRecording) {
                        setImmersiveTimer();
                    }
                }
            });
            
            // キーボードで没入モード終了
            document.addEventListener('keydown', (e) => {
                if (document.body.classList.contains('immersive-mode')) {
                    console.log('没入モード中にキーが押されました');
                    exitImmersiveMode();
                    if (appState.isRecording) {
                        setImmersiveTimer();
                    }
                }
            });
            
            // 設定画面のボタン
            document.getElementById('add-category-btn').addEventListener('click', () => openModal());
            document.getElementById('export-btn').addEventListener('click', exportData);
            
            // モーダルのボタン
            document.getElementById('cancel-btn').addEventListener('click', closeModal);
            document.getElementById('save-btn').addEventListener('click', saveCategory);
            
            // カラーピッカーの同期
            document.getElementById('color-picker').addEventListener('change', (e) => {
                document.getElementById('color-input').value = e.target.value;
                updateColorPalette();
            });
            
            document.getElementById('color-input').addEventListener('input', (e) => {
                const color = e.target.value;
                if (/^#[0-9A-Fa-f]{6}$/.test(color)) {
                    document.getElementById('color-picker').value = color;
                    updateColorPalette();
                }
            });
            
            // カテゴリ名入力でのEnterキー
            document.getElementById('category-name-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    saveCategory();
                } else if (e.key === 'Escape') {
                    closeModal();
                }
            });
            
            // モーダル背景クリックで閉じる
            document.getElementById('category-modal').addEventListener('click', (e) => {
                if (e.target.id === 'category-modal') {
                    closeModal();
                }
            });
            
            // PWA用のキーボードショートカット
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + Space でタイマー開始/停止
                if ((e.ctrlKey || e.metaKey) && e.code === 'Space') {
                    e.preventDefault();
                    if (appState.activeScreen === 'record') {
                        toggleRecording();
                    }
                }
                
                // Ctrl/Cmd + 1,2,3 で画面切り替え
                if ((e.ctrlKey || e.metaKey) && e.key >= '1' && e.key <= '3') {
                    e.preventDefault();
                    const screens = ['record', 'stats', 'settings'];
                    switchScreen(screens[parseInt(e.key) - 1]);
                }
            });
        }

        // アプリケーション初期化
        function initApp() {
            // 保存された設定を適用
            setTheme(appState.currentTheme);
            setFont(appState.currentFont);
            setBackground(appState.currentBackground);
            
            updateCurrentTime();
            updateCategoryDropdown();
            updateRecordingStatus();
            setupEventListeners();
            
            // PWA用のサービスワーカー登録
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:text/javascript,');
            }
            
            // PWAインストールプロンプト
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                setTimeout(() => {
                    if (confirm('TapTimeをホーム画面に追加しますか？アプリのように使用できます。')) {
                        e.prompt();
                    }
                }, 10000); // 10秒後に表示
            });
        }

        // ページ読み込み完了時に初期化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        // ページ離脱時にデータを保存
        window.addEventListener('beforeunload', () => {
            localStorage.setItem('taptime-categories', JSON.stringify(appState.categories));
            localStorage.setItem('taptime-records', JSON.stringify(appState.records));
            localStorage.setItem('taptime-selected-category', appState.selectedCategory.toString());
        });

        // ページ読み込み時にデータを復元
        window.addEventListener('load', () => {
            try {
                const savedCategories = localStorage.getItem('taptime-categories');
                const savedRecords = localStorage.getItem('taptime-records');
                const savedSelectedCategory = localStorage.getItem('taptime-selected-category');
                
                if (savedCategories) {
                    appState.categories = JSON.parse(savedCategories);
                }
                
                if (savedRecords) {
                    appState.records = JSON.parse(savedRecords);
                }
                
                if (savedSelectedCategory) {
                    appState.selectedCategory = parseInt(savedSelectedCategory);
                }
                
                updateCategoryDropdown();
            } catch (error) {
                console.warn('データの復元に失敗しました:', error);
            }
        });
    </script>
</body>
</html>
            