<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TapTime - ÊôÇÈñìÁÆ°ÁêÜ„Ç¢„Éó„É™</title>
    <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;TapTime&quot;,&quot;short_name&quot;:&quot;TapTime&quot;,&quot;description&quot;:&quot;„Çø„ÉÉ„Éó„Åô„Çã„Å†„Åë„ÄÅ„ÅÇ„Å™„Åü„ÅÆÊôÇÈñì„ÅåË¶ã„Åà„Å¶„Åè„Çã&quot;,&quot;start_url&quot;:&quot;/&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#ffffff&quot;,&quot;theme_color&quot;:&quot;#3b82f6&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233b82f6'/%3E%3Ctext x='50' y='60' text-anchor='middle' fill='white' font-size='30' font-family='Arial'%3E‚è∞%3C/text%3E%3C/svg%3E&quot;,&quot;sizes&quot;:&quot;192x192&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;}]}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="TapTime">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=Noto+Sans+JP:wght@300;400;500;600;700&family=M+PLUS+Rounded+1c:wght@400;700;900&family=Klee+One:wght@400;600&family=Noto+Serif+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Light Theme (Default) */
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-gradient-start: #eff6ff;
            --bg-gradient-end: #e0e7ff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            --border-color: #d1d5db;
            --shadow-color: rgba(0,0,0,0.1);
            --card-bg: #ffffff;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --overlay-bg: rgba(0,0,0,0.5);
            --font-family: 'Noto Sans JP', sans-serif;
        }

        [data-theme="pastel-pink"] {
            --bg-primary: #fef7f7;
            --bg-secondary: #fdf2f2;
            --bg-gradient-start: #fef7f7;
            --bg-gradient-end: #fce7e7;
            --text-primary: #7c2d2d;
            --text-secondary: #a85252;
            --text-muted: #d87979;
            --border-color: #f4c2c2;
            --shadow-color: rgba(220, 96, 96, 0.1);
            --card-bg: #ffffff;
            --accent-color: #dc6060;
            --accent-hover: #c55555;
            --success-color: #34d399;
            --danger-color: #f87171;
            --overlay-bg: rgba(220, 96, 96, 0.5);
        }

        [data-theme="pastel-blue"] {
            --bg-primary: #f0f9ff;
            --bg-secondary: #e0f4ff;
            --bg-gradient-start: #f0f9ff;
            --bg-gradient-end: #dbeafe;
            --text-primary: #1e3a8a;
            --text-secondary: #3b82f6;
            --text-muted: #60a5fa;
            --border-color: #bfdbfe;
            --shadow-color: rgba(59, 130, 246, 0.1);
            --card-bg: #ffffff;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --success-color: #34d399;
            --danger-color: #f87171;
            --overlay-bg: rgba(59, 130, 246, 0.5);
        }

        [data-theme="pastel-green"] {
            --bg-primary: #f0fdf4;
            --bg-secondary: #e7fced;
            --bg-gradient-start: #f0fdf4;
            --bg-gradient-end: #dcfce7;
            --text-primary: #166534;
            --text-secondary: #16a34a;
            --text-muted: #4ade80;
            --border-color: #bbf7d0;
            --shadow-color: rgba(34, 197, 94, 0.1);
            --card-bg: #ffffff;
            --accent-color: #22c55e;
            --accent-hover: #16a34a;
            --success-color: #10b981;
            --danger-color: #f87171;
            --overlay-bg: rgba(34, 197, 94, 0.5);
        }

        [data-theme="pastel-purple"] {
            --bg-primary: #fef7ff;
            --bg-secondary: #fdf4ff;
            --bg-gradient-start: #fef7ff;
            --bg-gradient-end: #f3e8ff;
            --text-primary: #5b21b6;
            --text-secondary: #7c3aed;
            --text-muted: #a855f7;
            --border-color: #e9d5ff;
            --shadow-color: rgba(139, 92, 246, 0.1);
            --card-bg: #ffffff;
            --accent-color: #8b5cf6;
            --accent-hover: #7c3aed;
            --success-color: #34d399;
            --danger-color: #f87171;
            --overlay-bg: rgba(139, 92, 246, 0.5);
        }

        [data-theme="pastel-orange"] {
            --bg-primary: #fff7ed;
            --bg-secondary: #ffedd5;
            --bg-gradient-start: #fff7ed;
            --bg-gradient-end: #fed7aa;
            --text-primary: #9a3412;
            --text-secondary: #c2410c;
            --text-muted: #fb923c;
            --border-color: #fdba74;
            --shadow-color: rgba(249, 115, 22, 0.1);
            --card-bg: #ffffff;
            --accent-color: #f97316;
            --accent-hover: #ea580c;
            --success-color: #34d399;
            --danger-color: #f87171;
            --overlay-bg: rgba(249, 115, 22, 0.5);
        }

        [data-theme="pastel-yellow"] {
            --bg-primary: #fffbeb;
            --bg-secondary: #fef3c7;
            --bg-gradient-start: #fffbeb;
            --bg-gradient-end: #fde68a;
            --text-primary: #92400e;
            --text-secondary: #d97706;
            --text-muted: #f59e0b;
            --border-color: #fde68a;
            --shadow-color: rgba(245, 158, 11, 0.1);
            --card-bg: #ffffff;
            --accent-color: #f59e0b;
            --accent-hover: #d97706;
            --success-color: #34d399;
            --danger-color: #f87171;
            --overlay-bg: rgba(245, 158, 11, 0.5);
        }

        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-gradient-start: #111827;
            --bg-gradient-end: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --border-color: #374151;
            --shadow-color: rgba(0,0,0,0.3);
            --card-bg: #1f2937;
            --accent-color: #60a5fa;
            --accent-hover: #3b82f6;
            --success-color: #34d399;
            --danger-color: #f87171;
            --overlay-bg: rgba(0,0,0,0.7);
        }

        /* Font variants */
        [data-font="cute"] { --font-family: 'Kosugi Maru', sans-serif; }
        [data-font="simple"] { --font-family: 'Noto Sans JP', sans-serif; }
        [data-font="bold"] { --font-family: 'M PLUS Rounded 1c', sans-serif; }
        [data-font="handwrite"] { --font-family: 'Klee One', cursive; }
        [data-font="serif"] { --font-family: 'Noto Serif JP', serif; }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding-bottom: 80px;
            color: var(--text-primary);
            transition: all 0.3s ease;
            position: relative;
        }

        /* Enhanced Background System */
        .background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .background-video {
            position: absolute;
            top: 50%;
            left: 50%;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            transform: translate(-50%, -50%);
            opacity: 0.6;
            object-fit: cover;
        }

        .background-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.6;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .background-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.8;
            background-size: cover;
            background-position: center;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 25px var(--shadow-color);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5rem;
            color: var(--text-primary);
            margin-bottom: 10px;
            font-weight: 800;
            background: linear-gradient(45deg, var(--accent-color), var(--success-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .timer-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 25px var(--shadow-color);
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
        }

        .timer-display {
            text-align: center;
            margin-bottom: 30px;
        }

        .elapsed-time {
            font-size: 3.5rem;
            font-family: var(--font-family);
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 15px;
            text-shadow: 0 2px 4px var(--shadow-color);
            transition: all 0.5s ease;
        }

        /* Ê≤°ÂÖ•„É¢„Éº„Éâ - ÈùûÂ∏∏„Å´„Ç∑„É≥„Éó„É´„Å™„Ç¢„Éó„É≠„Éº„ÉÅ */
        body.immersive-mode #record-screen .header,
        body.immersive-mode #record-screen .category-select,
        body.immersive-mode #record-screen .main-button,
        body.immersive-mode #record-screen .recording-status,
        body.immersive-mode #record-screen .current-time {
            display: none !important;
        }

        body.immersive-mode #record-screen .timer-card {
            background: transparent !important;
            box-shadow: none !important;
            border: none !important;
        }

        body.immersive-mode #record-screen .timer-display {
            position: fixed !important;
            top: 50vh !important;
            left: 50% !important;
            transform: translateX(-50%) translateY(-55%) !important;
            z-index: 9999 !important;
            margin: 0 !important;
            width: 100vw !important;
            text-align: center !important;
        }

        body.immersive-mode #record-screen .elapsed-time {
            font-size: 5rem !important;
            color: rgba(255, 255, 255, 0.95) !important;
            text-shadow: 0 0 40px rgba(0, 0, 0, 0.9), 3px 3px 6px rgba(0, 0, 0, 0.8) !important;
            background: none !important;
            padding: 0 !important;
            border-radius: 0 !important;
            backdrop-filter: none !important;
            border: none !important;
            margin: 0 !important;
            display: block !important;
            box-shadow: none !important;
        }

        body.immersive-mode #record-screen .timer-card {
            background: none !important;
            box-shadow: none !important;
            border: none !important;
            backdrop-filter: none !important;
        }

        body.immersive-mode .navigation {
            display: none !important;
        }

        /* Ê≤°ÂÖ•„É¢„Éº„ÉâÁî®„Ç™„Éº„Éê„Éº„É¨„Ç§ */
        .immersive-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 5;
            cursor: pointer;
            display: none;
            background: transparent;
        }

        body.immersive-mode .immersive-overlay {
            display: block !important;
        }

        .current-time {
            font-size: 1.2rem;
            color: var(--text-secondary);
        }

        .category-select {
            margin-bottom: 30px;
        }

        .category-select label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .dropdown {
            position: relative;
            width: 100%;
        }

        .dropdown-button {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--card-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 1rem;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .dropdown-button:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .dropdown-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .dropdown-content {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 5px;
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            box-shadow: 0 10px 25px var(--shadow-color);
            z-index: 100;
            max-height: 240px;
            overflow-y: auto;
        }

        .dropdown-item {
            width: 100%;
            padding: 15px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: background 0.2s ease;
        }

        .dropdown-item:hover {
            background: var(--bg-secondary);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .color-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .main-button {
            width: 100%;
            padding: 20px;
            border: none;
            border-radius: 15px;
            font-size: 1.3rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            position: relative;
            overflow: hidden;
        }

        .main-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .main-button:hover::before {
            left: 100%;
        }

        .main-button.start {
            background: linear-gradient(45deg, var(--accent-color), var(--success-color));
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }

        .main-button.start:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(59, 130, 246, 0.4);
        }

        .main-button.stop {
            background: linear-gradient(45deg, var(--danger-color), #f97316);
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
        }

        .main-button.stop:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(239, 68, 68, 0.4);
        }

        .recording-status {
            margin-top: 15px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid var(--border-color);
        }

        .recording-status-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .navigation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            padding: 15px;
            backdrop-filter: blur(10px);
        }

        .nav-items {
            display: flex;
            justify-content: space-around;
            max-width: 480px;
            margin: 0 auto;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }

        .nav-item.active {
            color: var(--accent-color);
            background: var(--bg-secondary);
        }

        .nav-item:hover {
            color: var(--text-primary);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            font-size: 1.2rem;
        }

        .nav-label {
            font-size: 0.75rem;
            font-weight: 600;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .stats-screen, .settings-screen {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .screen-title {
            font-size: 2rem;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 30px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px var(--shadow-color);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .date-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 30px;
        }

        .date-nav button {
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .date-nav button:hover {
            background: var(--bg-secondary);
            transform: scale(1.05);
        }

        .date-nav button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .date-display {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stat-item {
            margin-bottom: 20px;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .stat-name {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stat-value {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .category-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .category-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .category-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .category-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 8px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 5px;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: var(--border-color);
            transform: scale(1.1);
        }

        .add-btn, .export-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .add-btn {
            background: linear-gradient(45deg, var(--accent-color), var(--success-color));
            color: white;
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }

        .export-btn {
            background: linear-gradient(45deg, var(--success-color), #06b6d4);
            color: white;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
        }

        /* Enhanced Theme Selector */
        .theme-selector {
            margin-bottom: 20px;
        }

        .theme-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .theme-option {
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            background: var(--card-bg);
        }

        .theme-option.active {
            border-color: var(--accent-color);
            background: var(--bg-secondary);
            transform: scale(1.05);
        }

        .theme-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--shadow-color);
        }

        .theme-preview {
            width: 100%;
            height: 40px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            overflow: hidden;
        }

        .theme-preview .color {
            flex: 1;
            height: 100%;
        }

        .theme-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        /* Font Selector */
        .font-selector {
            margin-bottom: 20px;
        }

        .font-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .font-option {
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            background: var(--card-bg);
        }

        .font-option.active {
            border-color: var(--accent-color);
            background: var(--bg-secondary);
        }

        .font-option:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px var(--shadow-color);
        }

        .font-sample {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .font-name {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Background Selector */
        .background-selector {
            margin-bottom: 20px;
        }

        .background-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .background-option {
            position: relative;
            aspect-ratio: 16/9;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .background-option.active {
            border-color: var(--accent-color);
            transform: scale(1.05);
        }

        .background-option:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px var(--shadow-color);
        }

        .background-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .background-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px;
            text-align: center;
            font-size: 0.7rem;
            font-weight: 500;
        }

        /* File Input for Custom Media */
        .file-input-container {
            margin-top: 15px;
            padding: 15px;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .file-input-container:hover {
            border-color: var(--accent-color);
            background: var(--bg-secondary);
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--overlay-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 40px var(--shadow-color);
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 25px;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--card-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .color-section {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .color-picker {
            width: 60px;
            height: 60px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            background: var(--card-bg);
        }

        .color-input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
        }

        .color-swatch {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .color-swatch:hover {
            transform: scale(1.1);
        }

        .color-swatch.selected {
            border-color: var(--text-primary);
            border-width: 3px;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--accent-color), var(--success-color));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .hidden {
            display: none !important;
        }

        .no-records {
            text-align: center;
            color: var(--text-muted);
            padding: 40px 20px;
        }

        .record-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
        }

        .record-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .record-details {
            flex: 1;
        }

        .record-category {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .record-time {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .record-duration {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Animations */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .floating {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 0.6; }
        }

        .background-container.active {
            animation: pulse 4s ease-in-out infinite;
        }

        /* PWA specific styles */
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: calc(80px + env(safe-area-inset-bottom));
            }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .stats-screen .card {
                grid-column: 1;
            }
            
            .container {
                padding: 15px;
            }
            
            .theme-options {
                grid-template-columns: 1fr 1fr;
            }

            .font-options {
                grid-template-columns: 1fr;
            }

            .background-options {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body data-theme="light" data-font="cute">
    <div class="background-container" id="background-container">
        <!-- Dynamic background content will be inserted here -->
    </div>
    
    <div id="app">
        <!-- Ë®òÈå≤ÁîªÈù¢ -->
        <div id="record-screen" class="screen active">
            <div class="container">
                <div class="header floating">
                    <h1>TapTime</h1>
                    <p>„Çø„ÉÉ„Éó„Åô„Çã„Å†„Åë„ÄÅ„ÅÇ„Å™„Åü„ÅÆÊôÇÈñì„ÅåË¶ã„Åà„Å¶„Åè„Çã</p>
                </div>

                <div class="timer-card">
                    <div class="timer-display">
                        <div id="elapsed-time" class="elapsed-time">00:00:00</div>
                        <div id="current-time" class="current-time"></div>
                    </div>

                    <div class="category-select">
                        <label>„Ç´„ÉÜ„Ç¥„É™ÈÅ∏Êäû</label>
                        <div class="dropdown">
                            <button id="category-dropdown-btn" class="dropdown-button">
                                <div id="selected-category">
                                    <span class="color-dot" style="background-color: #3b82f6;"></span>
                                    <span>ÂãâÂº∑</span>
                                </div>
                                <span>‚ñº</span>
                            </button>
                            <div id="category-dropdown" class="dropdown-content hidden">
                                <!-- „Ç´„ÉÜ„Ç¥„É™„Ç™„Éó„Ç∑„Éß„É≥„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                            </div>
                        </div>
                    </div>

                    <button id="main-button" class="main-button start">
                        <span>‚ñ∂</span>
                        <span>ÈñãÂßã</span>
                    </button>

                    <div id="recording-status" class="recording-status hidden">
                        <span class="color-dot" style="background-color: #3b82f6;"></span>
                        <span class="recording-status-text">ÂãâÂº∑ „ÇíË®òÈå≤‰∏≠...</span>
                    </div>
                </div>

                <!-- Immersive mode overlay -->
                <div class="immersive-overlay" id="immersive-overlay"></div>
            </div>
        </div>

        <!-- Áµ±Ë®àÁîªÈù¢ -->
        <div id="stats-screen" class="screen">
            <div class="stats-screen">
                <div class="date-nav">
                    <h2 class="screen-title">Áµ±Ë®à</h2>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <button id="prev-day">‚Üê</button>
                        <div id="view-date" class="date-display"></div>
                        <button id="next-day">‚Üí</button>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr; gap: 20px;">
                    <div class="card">
                        <h3 class="card-title">„Ç´„ÉÜ„Ç¥„É™Âà•ÊôÇÈñì</h3>
                        <div id="category-stats">
                            <div class="no-records">„Åì„ÅÆÊó•„ÅÆË®òÈå≤„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">Ë®òÈå≤‰∏ÄË¶ß</h3>
                        <div id="record-list" class="record-list">
                            <div class="no-records">„Åì„ÅÆÊó•„ÅÆË®òÈå≤„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ë®≠ÂÆöÁîªÈù¢ -->
        <div id="settings-screen" class="screen">
            <div class="settings-screen">
                <h2 class="screen-title">Ë®≠ÂÆö</h2>

                <!-- „ÉÜ„Éº„ÉûË®≠ÂÆö -->
                <div class="card">
                    <h3 class="card-title">Â§ñË¶≥Ë®≠ÂÆö</h3>
                    
                    <div class="theme-selector">
                        <label class="form-label">„Ç´„É©„Éº„ÉÜ„Éº„Éû</label>
                        <div class="theme-options">
                            <div class="theme-option active" data-theme="light">
                                <div class="theme-preview">
                                    <div class="color" style="background: #eff6ff;"></div>
                                    <div class="color" style="background: #3b82f6;"></div>
                                    <div class="color" style="background: #ffffff;"></div>
                                </div>
                                <div class="theme-name">„É©„Ç§„Éà</div>
                            </div>
                            
                            <div class="theme-option" data-theme="dark">
                                <div class="theme-preview">
                                    <div class="color" style="background: #111827;"></div>
                                    <div class="color" style="background: #60a5fa;"></div>
                                    <div class="color" style="background: #1f2937;"></div>
                                </div>
                                <div class="theme-name">„ÉÄ„Éº„ÇØ</div>
                            </div>
                            
                            <div class="theme-option" data-theme="pastel-pink">
                                <div class="theme-preview">
                                    <div class="color" style="background: #fef7f7;"></div>
                                    <div class="color" style="background: #dc6060;"></div>
                                    <div class="color" style="background: #fce7e7;"></div>
                                </div>
                                <div class="theme-name">„Éë„Çπ„ÉÜ„É´„Éî„É≥„ÇØ</div>
                            </div>

                            <div class="theme-option" data-theme="pastel-blue">
                                <div class="theme-preview">
                                    <div class="color" style="background: #f0f9ff;"></div>
                                    <div class="color" style="background: #3b82f6;"></div>
                                    <div class="color" style="background: #dbeafe;"></div>
                                </div>
                                <div class="theme-name">„Éë„Çπ„ÉÜ„É´„Éñ„É´„Éº</div>
                            </div>

                            <div class="theme-option" data-theme="pastel-green">
                                <div class="theme-preview">
                                    <div class="color" style="background: #f0fdf4;"></div>
                                    <div class="color" style="background: #22c55e;"></div>
                                    <div class="color" style="background: #dcfce7;"></div>
                                </div>
                                <div class="theme-name">„Éë„Çπ„ÉÜ„É´„Ç∞„É™„Éº„É≥</div>
                            </div>

                            <div class="theme-option" data-theme="pastel-purple">
                                <div class="theme-preview">
                                    <div class="color" style="background: #fef7ff;"></div>
                                    <div class="color" style="background: #8b5cf6;"></div>
                                    <div class="color" style="background: #f3e8ff;"></div>
                                </div>
                                <div class="theme-name">„Éë„Çπ„ÉÜ„É´„Éë„Éº„Éó„É´</div>
                            </div>

                            <div class="theme-option" data-theme="pastel-orange">
                                <div class="theme-preview">
                                    <div class="color" style="background: #fff7ed;"></div>
                                    <div class="color" style="background: #f97316;"></div>
                                    <div class="color" style="background: #fed7aa;"></div>
                                </div>
                                <div class="theme-name">„Éë„Çπ„ÉÜ„É´„Ç™„É¨„É≥„Ç∏</div>
                            </div>
                            <div class="theme-option" data-theme="pastel-yellow">
                                <div class="theme-preview">
                                    <div class="color" style="background: #fffbeb;"></div>
                                    <div class="color" style="background: #f59e0b;"></div>
                                    <div class="color" style="background: #fde68a;"></div>
                                </div>
                                <div class="theme-name">„Éë„Çπ„ÉÜ„É´„Ç§„Ç®„É≠„Éº</div>
                            </div>
                        </div>
                    </div>

                    <div class="font-selector">
                        <label class="form-label">„Éï„Ç©„É≥„Éà</label>
                        <div class="font-options">
                            <div class="font-option active" data-font="cute">
                                <div class="font-sample" style="font-family: 'Kosugi Maru', sans-serif;">ÊôÇÈñì„ÇíË®à„Çã</div>
                                <div class="font-name">„Åã„Çè„ÅÑ„ÅÑÁ≥ª</div>
                            </div>
                            <div class="font-option" data-font="simple">
                                <div class="font-sample" style="font-family: 'Noto Sans JP', sans-serif;">ÊôÇÈñì„ÇíË®à„Çã</div>
                                <div class="font-name">„Ç∑„É≥„Éó„É´</div>
                            </div>
                            <div class="font-option" data-font="bold">
                                <div class="font-sample" style="font-family: 'M PLUS Rounded 1c', sans-serif; font-weight: 900;">ÊôÇÈñì„ÇíË®à„Çã</div>
                                <div class="font-name">Â§™„ÅÑ</div>
                            </div>
                            <div class="font-option" data-font="handwrite">
                                <div class="font-sample" style="font-family: 'Klee One', cursive;">ÊôÇÈñì„ÇíË®à„Çã</div>
                                <div class="font-name">ÊâãÊõ∏„ÅçÈ¢®</div>
                            </div>
                            <div class="font-option" data-font="serif">
                                <div class="font-sample" style="font-family: 'Noto Serif JP', serif;">ÊôÇÈñì„ÇíË®à„Çã</div>
                                <div class="font-name">ÊòéÊúù</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ËÉåÊôØË®≠ÂÆö -->
                <div class="card">
                    <h3 class="card-title">ËÉåÊôØË®≠ÂÆö</h3>
                    
                    <div class="background-selector">
                        <label class="form-label">ËÉåÊôØ„ÇíÈÅ∏Êäû</label>
                        <div class="background-options" id="background-options">
                            <div class="background-option active" data-bg="none">
                                <div class="background-preview" style="background: linear-gradient(45deg, #f0f9ff, #e0e7ff);"></div>
                                <div class="background-label">„Å™„Åó</div>
                            </div>
                        </div>
                        
                        <div class="file-input-container">
                            <input type="file" id="custom-background" class="file-input" accept="video/*,image/*,.gif">
                            <label for="custom-background" class="file-input-label">
                                üìÅ „Ç´„Çπ„Çø„É†ËÉåÊôØ„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ<br>
                                <small>ÂãïÁîª„ÄÅÁîªÂÉè„ÄÅGIF„Éï„Ç°„Ç§„É´„Å´ÂØæÂøú</small>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- „Ç´„ÉÜ„Ç¥„É™ÁÆ°ÁêÜ -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 class="card-title" style="margin-bottom: 0;">„Ç´„ÉÜ„Ç¥„É™ÁÆ°ÁêÜ</h3>
                        <button id="add-category-btn" class="add-btn">
                            <span>+</span>
                            <span>ËøΩÂä†</span>
                        </button>
                    </div>
                    <div id="category-list" class="category-list">
                        <!-- „Ç´„ÉÜ„Ç¥„É™„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                    </div>
                </div>

                <!-- „Éá„Éº„ÇøÁÆ°ÁêÜ -->
                <div class="card">
                    <h3 class="card-title">„Éá„Éº„Çø</h3>
                    <button id="export-btn" class="export-btn">
                        <span>üì•</span>
                        <span>CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà</span>
                    </button>
                    <p style="margin-top: 10px; font-size: 0.9rem; color: var(--text-secondary);">
                        Ë®òÈå≤„Éá„Éº„Çø„ÇíCSV„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åô
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
    <div class="navigation">
        <div class="nav-items">
            <button class="nav-item active" data-screen="record">
                <div class="nav-icon">‚è±Ô∏è</div>
                <div class="nav-label">Ë®òÈå≤</div>
            </button>
            <button class="nav-item" data-screen="stats">
                <div class="nav-icon">üìä</div>
                <div class="nav-label">Áµ±Ë®à</div>
            </button>
            <button class="nav-item" data-screen="settings">
                <div class="nav-icon">‚öôÔ∏è</div>
                <div class="nav-label">Ë®≠ÂÆö</div>
            </button>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´ -->
    <div id="category-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="modal-title">„Ç´„ÉÜ„Ç¥„É™ËøΩÂä†</h3>
            
            <div class="form-group">
                <label class="form-label">„Ç´„ÉÜ„Ç¥„É™Âêç</label>
                <input type="text" id="category-name-input" class="form-input" placeholder="„Ç´„ÉÜ„Ç¥„É™Âêç„ÇíÂÖ•Âäõ">
            </div>

            <div class="form-group">
                <label class="form-label">„Ç´„É©„Éº</label>
                <div class="color-section">
                    <input type="color" id="color-picker" class="color-picker" value="#3b82f6">
                    <input type="text" id="color-input" class="color-input" value="#3b82f6" placeholder="#3b82f6">
                </div>
                <div class="color-palette" id="color-palette">
                    <!-- „Éó„É™„Çª„ÉÉ„Éà„Ç´„É©„Éº„Åå„Åì„Åì„Å´ËøΩÂä†„Åï„Çå„Çã -->
                </div>
            </div>

            <div class="modal-buttons">
                <button id="cancel-btn" class="btn btn-secondary">„Ç≠„É£„É≥„Çª„É´</button>
                <button id="save-btn" class="btn btn-primary">ËøΩÂä†</button>
            </div>
        </div>
    </div>

    <script>
        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÅÆÁä∂ÊÖã
        let appState = {
            currentTime: new Date(),
            isRecording: false,
            recordingStart: null,
            elapsedTime: 0,
            selectedCategory: 1,
            activeScreen: 'record',
            categories: [
                { id: 1, name: 'ÂãâÂº∑', color: '#3b82f6' },
                { id: 2, name: '‰ªï‰∫ã', color: '#10b981' },
                { id: 3, name: 'Ë™≠Êõ∏', color: '#8b5cf6' },
                { id: 4, name: 'ÈÅãÂãï', color: '#f59e0b' }
            ],
            records: [],
            viewDate: new Date(),
            editingCategory: null,
            currentTheme: localStorage.getItem('taptime-theme') || 'light',
            currentFont: localStorage.getItem('taptime-font') || 'cute',
            currentBackground: localStorage.getItem('taptime-background') || 'none',
            customBackgrounds: JSON.parse(localStorage.getItem('taptime-custom-backgrounds') || '[]'),
            immersiveTimeout: null
        };

        // „Éó„É™„Çª„ÉÉ„Éà„Ç´„É©„Éº
        const presetColors = [
            '#3b82f6', '#10b981', '#8b5cf6', '#f59e0b',
            '#ef4444', '#06b6d4', '#84cc16', '#f97316',
            '#ec4899', '#6366f1', '#14b8a6', '#eab308',
            '#dc2626', '#0891b2', '#65a30d', '#ea580c'
        ];

        // „Éó„É™„Çª„ÉÉ„ÉàËÉåÊôØ
        const presetBackgrounds = [
            {
                id: 'lofi-study-1',
                name: 'LoFiÂãâÂº∑ÈÉ®Â±ã',
                type: 'image',
                url: './lofi-study-1.gif'
            },
            {
                id: 'lofi-night-room',
                name: 'LoFiÂ§ú„ÅÆÈÉ®Â±ã',
                type: 'image', 
                url: './lofi-night-room.gif'
            },
            {
                id: 'lofi-cyber-room',
                name: 'LoFi„Çµ„Ç§„Éê„ÉºÈÉ®Â±ã', 
                type: 'image',
                url: './lofi-cyber-room.gif'
            }
        ];

        // „ÉÜ„Éº„ÉûË®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å®ÈÅ©Áî®
        function setTheme(theme) {
            appState.currentTheme = theme;
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('taptime-theme', theme);
            
            // „ÉÜ„Éº„Éû„Ç™„Éó„Ç∑„Éß„É≥„ÅÆË°®Á§∫Êõ¥Êñ∞
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.toggle('active', option.dataset.theme === theme);
            });
        }

        // „Éï„Ç©„É≥„ÉàË®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å®ÈÅ©Áî®
        function setFont(font) {
            appState.currentFont = font;
            document.body.setAttribute('data-font', font);
            localStorage.setItem('taptime-font', font);
            
            // „Éï„Ç©„É≥„Éà„Ç™„Éó„Ç∑„Éß„É≥„ÅÆË°®Á§∫Êõ¥Êñ∞
            document.querySelectorAll('.font-option').forEach(option => {
                option.classList.toggle('active', option.dataset.font === font);
            });
        }

        // ËÉåÊôØË®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å®ÈÅ©Áî®
        function setBackground(backgroundId) {
            appState.currentBackground = backgroundId;
            localStorage.setItem('taptime-background', backgroundId);
            
            const container = document.getElementById('background-container');
            container.innerHTML = '';
            
            if (backgroundId === 'none') {
                container.classList.remove('active');
                return;
            }
            
            // „Ç´„Çπ„Çø„É†ËÉåÊôØ„ÅÆÁ¢∫Ë™ç
            const customBg = appState.customBackgrounds.find(bg => bg.id === backgroundId);
            if (customBg) {
                if (customBg.type === 'video') {
                    const video = document.createElement('video');
                    video.className = 'background-video';
                    video.src = customBg.url;
                    video.autoplay = true;
                    video.loop = true;
                    video.muted = true;
                    video.playsInline = true;
                    container.appendChild(video);
                } else {
                    const img = document.createElement('div');
                    img.className = 'background-image';
                    img.style.backgroundImage = `url(${customBg.url})`;
                    container.appendChild(img);
                }
            } else {
                // „Éó„É™„Çª„ÉÉ„ÉàËÉåÊôØ
                const presetBg = presetBackgrounds.find(bg => bg.id === backgroundId);
                if (presetBg) {
                    const bgElement = document.createElement('div');
                    bgElement.className = 'background-svg';
                    bgElement.style.backgroundImage = `url('${presetBg.url}')`;
                    container.appendChild(bgElement);
                }
            }
            
            container.classList.add('active');
            
            // ËÉåÊôØ„Ç™„Éó„Ç∑„Éß„É≥„ÅÆË°®Á§∫Êõ¥Êñ∞
            document.querySelectorAll('.background-option').forEach(option => {
                option.classList.toggle('active', option.dataset.bg === backgroundId);
            });
        }

        // „Ç´„Çπ„Çø„É†ËÉåÊôØ„ÅÆËøΩÂä†
        function addCustomBackground(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const customBg = {
                    id: 'custom-' + Date.now(),
                    name: file.name,
                    type: file.type.startsWith('video/') ? 'video' : 'image',
                    url: e.target.result
                };
                
                appState.customBackgrounds.push(customBg);
                localStorage.setItem('taptime-custom-backgrounds', JSON.stringify(appState.customBackgrounds));
                
                updateBackgroundOptions();
                setBackground(customBg.id);
            };
            reader.readAsDataURL(file);
        }

        // ËÉåÊôØ„Ç™„Éó„Ç∑„Éß„É≥„ÅÆÊõ¥Êñ∞
        function updateBackgroundOptions() {
            const container = document.getElementById('background-options');
            let html = `
                <div class="background-option ${appState.currentBackground === 'none' ? 'active' : ''}" data-bg="none">
                    <div class="background-preview" style="background: linear-gradient(45deg, #f0f9ff, #e0e7ff);"></div>
                    <div class="background-label">„Å™„Åó</div>
                </div>
            `;
            
            // „Éó„É™„Çª„ÉÉ„ÉàËÉåÊôØ„ÇíËøΩÂä†
            presetBackgrounds.forEach(bg => {
                const isActive = appState.currentBackground === bg.id;
                html += `
                    <div class="background-option ${isActive ? 'active' : ''}" data-bg="${bg.id}">
                        <div class="background-preview" style="background-image: url('${bg.url}'); background-size: cover; background-position: center;"></div>
                        <div class="background-label">${bg.name}</div>
                    </div>
                `;
            });
            
            // „Ç´„Çπ„Çø„É†ËÉåÊôØ„ÇíËøΩÂä†
            appState.customBackgrounds.forEach(bg => {
                const isActive = appState.currentBackground === bg.id;
                html += `
                    <div class="background-option ${isActive ? 'active' : ''}" data-bg="${bg.id}">
                        <div class="background-preview" style="background-image: url('${bg.url}'); background-size: cover; background-position: center;"></div>
                        <div class="background-label">${bg.name}</div>
                        <button class="action-btn" style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.5); color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px;" onclick="removeCustomBackground('${bg.id}')">√ó</button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíËøΩÂä†
            container.querySelectorAll('.background-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('action-btn')) {
                        setBackground(option.dataset.bg);
                    }
                });
            });
        }

        // Ê≤°ÂÖ•„É¢„Éº„Éâ„ÅÆÂà∂Âæ° - ÊúÄ„ÇÇ„Ç∑„É≥„Éó„É´„Å™ÊñπÊ≥ï
        function enterImmersiveMode() {
            document.body.classList.add('immersive-mode');
            document.getElementById('immersive-overlay').style.display = 'block';
            console.log('Ê≤°ÂÖ•„É¢„Éº„Éâ ON - body„Å´„ÇØ„É©„ÇπËøΩÂä†');
        }

        function exitImmersiveMode() {
            document.body.classList.remove('immersive-mode');
            document.getElementById('immersive-overlay').style.display = 'none';
            console.log('Ê≤°ÂÖ•„É¢„Éº„Éâ OFF - body„Åã„Çâ„ÇØ„É©„ÇπÂâäÈô§');
        }

        // Ê≤°ÂÖ•„É¢„Éº„Éâ„Çø„Ç§„Éû„Éº„ÅÆË®≠ÂÆö
        function setImmersiveTimer() {
            if (appState.immersiveTimeout) {
                clearTimeout(appState.immersiveTimeout);
            }
            
            if (appState.isRecording && appState.activeScreen === 'record') {
                console.log('Setting immersive timer for 5 seconds');
                appState.immersiveTimeout = setTimeout(() => {
                    if (appState.isRecording && appState.activeScreen === 'record') {
                        console.log('Entering immersive mode after 5 seconds');
                        enterImmersiveMode();
                    }
                }, 5000); // 5ÁßíÂæå„Å´Ê≤°ÂÖ•„É¢„Éº„Éâ
            }
        }

        // Ê≤°ÂÖ•„É¢„Éº„Éâ„Çø„Ç§„Éû„Éº„ÅÆ„ÇØ„É™„Ç¢
        function clearImmersiveTimer() {
            if (appState.immersiveTimeout) {
                clearTimeout(appState.immersiveTimeout);
                appState.immersiveTimeout = null;
            }
            exitImmersiveMode();
        }

        // „Éö„Éº„Ç∏„ÅÆË°®Á§∫Áä∂ÊÖãÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
        function handleVisibilityChange() {
            if (document.hidden) {
                // „Çø„Éñ„ÅåÈùûË°®Á§∫„Å´„Å™„Å£„ÅüÊôÇ
                console.log('„Çø„Éñ„ÅåÈùûË°®Á§∫„Å´„Å™„Çä„Åæ„Åó„Åü');
                if (appState.immersiveTimeout) {
                    clearTimeout(appState.immersiveTimeout);
                    appState.immersiveTimeout = null;
                }
                exitImmersiveMode();
            } else {
                // „Çø„Éñ„ÅåË°®Á§∫Áä∂ÊÖã„Å´Êàª„Å£„ÅüÊôÇ
                console.log('„Çø„Éñ„ÅåË°®Á§∫Áä∂ÊÖã„Å´Êàª„Çä„Åæ„Åó„Åü');
                // „Çø„ÉñÂæ©Â∏∞ÊôÇ„ÅØÊ≤°ÂÖ•„É¢„Éº„Éâ„Å´ÂÖ•„Çâ„Å™„ÅÑÔºàÊâãÂãïÊìç‰Ωú„ÇíÂæÖ„Å§Ôºâ
                console.log('„Çø„ÉñÂæ©Â∏∞ÊôÇ„ÅØÊ≤°ÂÖ•„É¢„Éº„Éâ„Çø„Ç§„Éû„Éº„ÇíË®≠ÂÆö„Åó„Åæ„Åõ„Çì');
            }
        }
        // „Ç´„Çπ„Çø„É†ËÉåÊôØ„ÅÆÂâäÈô§
        function removeCustomBackground(bgId) {
            if (confirm('„Åì„ÅÆËÉåÊôØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                appState.customBackgrounds = appState.customBackgrounds.filter(bg => bg.id !== bgId);
                localStorage.setItem('taptime-custom-backgrounds', JSON.stringify(appState.customBackgrounds));
                
                if (appState.currentBackground === bgId) {
                    setBackground('none');
                }
                
                updateBackgroundOptions();
            }
        }

        // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
        function formatTime(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            return `${hours.toString().padStart(2, '0')}:${(minutes % 60).toString().padStart(2, '0')}:${(seconds % 60).toString().padStart(2, '0')}`;
        }

        function getCategoryById(id) {
            return appState.categories.find(cat => cat.id === id);
        }

        function updateCurrentTime() {
            appState.currentTime = new Date();
            document.getElementById('current-time').textContent = appState.currentTime.toLocaleTimeString('ja-JP');
            
            if (appState.isRecording && appState.recordingStart) {
                appState.elapsedTime = Date.now() - appState.recordingStart;
                document.getElementById('elapsed-time').textContent = formatTime(appState.elapsedTime);
            }
        }

        function updateCategoryDropdown() {
            const dropdown = document.getElementById('category-dropdown');
            const selectedDisplay = document.getElementById('selected-category');
            
            // ÈÅ∏Êäû‰∏≠„ÅÆ„Ç´„ÉÜ„Ç¥„É™Ë°®Á§∫„ÇíÊõ¥Êñ∞
            const selectedCategory = getCategoryById(appState.selectedCategory);
            if (selectedCategory) {
                selectedDisplay.innerHTML = `
                    <span class="color-dot" style="background-color: ${selectedCategory.color};"></span>
                    <span>${selectedCategory.name}</span>
                `;
            }

            // „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„Ç™„Éó„Ç∑„Éß„É≥„ÇíÊõ¥Êñ∞
            dropdown.innerHTML = '';
            appState.categories.forEach(category => {
                const item = document.createElement('button');
                item.className = 'dropdown-item';
                item.innerHTML = `
                    <span class="color-dot" style="background-color: ${category.color};"></span>
                    <span>${category.name}</span>
                `;
                item.addEventListener('click', () => {
                    appState.selectedCategory = category.id;
                    updateCategoryDropdown();
                    updateRecordingStatus();
                    dropdown.classList.add('hidden');
                });
                dropdown.appendChild(item);
            });
        }

        function updateRecordingStatus() {
            const status = document.getElementById('recording-status');
            const mainButton = document.getElementById('main-button');
            const dropdownBtn = document.getElementById('category-dropdown-btn');
            
            if (appState.isRecording) {
                const category = getCategoryById(appState.selectedCategory);
                status.innerHTML = `
                    <span class="color-dot" style="background-color: ${category.color};"></span>
                    <span class="recording-status-text">${category.name} „ÇíË®òÈå≤‰∏≠...</span>
                `;
                status.classList.remove('hidden');
                mainButton.className = 'main-button stop';
                mainButton.innerHTML = '<span>‚è∏</span><span>ÂÅúÊ≠¢</span>';
                dropdownBtn.disabled = true;
            } else {
                status.classList.add('hidden');
                mainButton.className = 'main-button start';
                mainButton.innerHTML = '<span>‚ñ∂</span><span>ÈñãÂßã</span>';
                dropdownBtn.disabled = false;
            }
        }

        function toggleRecording() {
            if (!appState.selectedCategory) {
                alert('„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            if (appState.isRecording) {
                // Ë®òÈå≤ÂÅúÊ≠¢
                const endTime = Date.now();
                const duration = endTime - appState.recordingStart;
                const newRecord = {
                    id: Date.now(),
                    categoryId: appState.selectedCategory,
                    startTime: appState.recordingStart,
                    endTime: endTime,
                    duration: duration,
                    date: new Date(appState.recordingStart).toDateString()
                };
                appState.records.push(newRecord);
                appState.isRecording = false;
                appState.recordingStart = null;
                appState.elapsedTime = 0;
                document.getElementById('elapsed-time').textContent = '00:00:00';
                
                // Ê≤°ÂÖ•„É¢„Éº„Éâ„ÇíÁµÇ‰∫Ü
                clearImmersiveTimer();
            } else {
                // Ë®òÈå≤ÈñãÂßã
                appState.recordingStart = Date.now();
                appState.isRecording = true;
                appState.elapsedTime = 0;
                
                // 5ÁßíÂæå„Å´Ê≤°ÂÖ•„É¢„Éº„Éâ„Å´ÂÖ•„Çã„Çø„Ç§„Éû„Éº„ÇíË®≠ÂÆö
                setImmersiveTimer();
            }
            
            updateRecordingStatus();
        }

        function switchScreen(screenName) {
            // ÂÖ®ÁîªÈù¢„ÇíÈùûË°®Á§∫
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Ç¢„Ç§„ÉÜ„É†„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // ÈÅ∏Êäû„Åï„Çå„ÅüÁîªÈù¢„ÇíË°®Á§∫
            document.getElementById(`${screenName}-screen`).classList.add('active');
            document.querySelector(`[data-screen="${screenName}"]`).classList.add('active');
            
            appState.activeScreen = screenName;
            
            // ÁîªÈù¢Âàá„ÇäÊõø„ÅàÊôÇ„Å´Ê≤°ÂÖ•„É¢„Éº„Éâ„ÇíÁµÇ‰∫Ü
            if (screenName !== 'record') {
                clearImmersiveTimer();
            } else if (screenName === 'record') {
                // Ë®òÈå≤ÁîªÈù¢„Å´Êàª„Å£„ÅüÊôÇ„ÄÅË®òÈå≤‰∏≠„Å™„Çâ5ÁßíÂæå„Å´Ê≤°ÂÖ•„É¢„Éº„Éâ
                if (appState.isRecording) {
                    console.log('Ë®òÈå≤ÁîªÈù¢„Å´Êàª„Çä„Åæ„Åó„Åü„ÄÇË®òÈå≤‰∏≠„Å™„ÅÆ„Åß5ÁßíÂæå„Å´Ê≤°ÂÖ•„É¢„Éº„Éâ„Å´ÂÖ•„Çä„Åæ„Åô');
                    setImmersiveTimer();
                }
            }
            
            // ÁîªÈù¢Âõ∫Êúâ„ÅÆÊõ¥Êñ∞Âá¶ÁêÜ
            if (screenName === 'stats') {
                updateStatsScreen();
            } else if (screenName === 'settings') {
                updateSettingsScreen();
            }
        }

        function updateStatsScreen() {
            document.getElementById('view-date').textContent = appState.viewDate.toLocaleDateString('ja-JP');
            
            const dateStr = appState.viewDate.toDateString();
            const dayRecords = appState.records.filter(record => record.date === dateStr);
            
            // „Ç´„ÉÜ„Ç¥„É™Âà•Áµ±Ë®à
            const categoryStats = {};
            let totalTime = 0;
            
            dayRecords.forEach(record => {
                const category = getCategoryById(record.categoryId);
                if (category) {
                    if (!categoryStats[category.name]) {
                        categoryStats[category.name] = { time: 0, color: category.color };
                    }
                    categoryStats[category.name].time += record.duration;
                    totalTime += record.duration;
                }
            });
            
            // Áµ±Ë®àË°®Á§∫
            const statsContainer = document.getElementById('category-stats');
            if (Object.keys(categoryStats).length === 0) {
                statsContainer.innerHTML = '<div class="no-records">„Åì„ÅÆÊó•„ÅÆË®òÈå≤„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
            } else {
                let html = '';
                Object.entries(categoryStats).forEach(([name, data]) => {
                    const percentage = totalTime > 0 ? (data.time / totalTime * 100) : 0;
                    html += `
                        <div class="stat-item">
                            <div class="stat-header">
                                <div class="stat-name">
                                    <span class="color-dot" style="background-color: ${data.color};"></span>
                                    <span>${name}</span>
                                </div>
                                <div class="stat-value">${formatTime(data.time)} (${percentage.toFixed(1)}%)</div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="background-color: ${data.color}; width: ${percentage}%;"></div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                    <div style="padding-top: 20px; border-top: 1px solid var(--border-color); margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; font-weight: bold;">
                            <span>ÂêàË®àÊôÇÈñì</span>
                            <span>${formatTime(totalTime)}</span>
                        </div>
                    </div>
                `;
                statsContainer.innerHTML = html;
            }
            
            // Ë®òÈå≤‰∏ÄË¶ß
            const recordList = document.getElementById('record-list');
            if (dayRecords.length === 0) {
                recordList.innerHTML = '<div class="no-records">„Åì„ÅÆÊó•„ÅÆË®òÈå≤„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
            } else {
                let html = '';
                dayRecords.sort((a, b) => b.startTime - a.startTime).forEach(record => {
                    const category = getCategoryById(record.categoryId);
                    html += `
                        <div class="record-item">
                            <div class="record-info">
                                <span class="color-dot" style="background-color: ${category.color};"></span>
                                <div class="record-details">
                                    <div class="record-category">${category.name}</div>
                                    <div class="record-time">
                                        ${new Date(record.startTime).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })} - 
                                        ${new Date(record.endTime).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })}
                                    </div>
                                </div>
                            </div>
                            <div class="record-duration">${formatTime(record.duration)}</div>
                        </div>
                    `;
                });
                recordList.innerHTML = html;
            }
            
            // Ê¨°„ÅÆÊó•„Éú„Çø„É≥„ÅÆÁä∂ÊÖã
            const today = new Date().toDateString();
            document.getElementById('next-day').disabled = appState.viewDate.toDateString() === today;
        }

        function updateSettingsScreen() {
            const categoryList = document.getElementById('category-list');
            let html = '';
            
            appState.categories.forEach(category => {
                html += `
                    <div class="category-item">
                        <div class="category-info">
                            <span class="color-dot" style="background-color: ${category.color};"></span>
                            <span class="category-name">${category.name}</span>
                        </div>
                        <div class="category-actions">
                            <button class="action-btn" onclick="editCategory(${category.id})">‚úèÔ∏è</button>
                            <button class="action-btn" onclick="deleteCategory(${category.id})" ${appState.categories.length <= 1 ? 'disabled' : ''}>üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });
            
            categoryList.innerHTML = html;
            updateBackgroundOptions();
        }

        function openModal(isEdit = false, category = null) {
            const modal = document.getElementById('category-modal');
            const title = document.getElementById('modal-title');
            const nameInput = document.getElementById('category-name-input');
            const colorPicker = document.getElementById('color-picker');
            const colorInput = document.getElementById('color-input');
            const saveBtn = document.getElementById('save-btn');
            
            appState.editingCategory = category;
            
            if (isEdit && category) {
                title.textContent = '„Ç´„ÉÜ„Ç¥„É™Á∑®ÈõÜ';
                nameInput.value = category.name;
                colorPicker.value = category.color;
                colorInput.value = category.color;
                saveBtn.textContent = 'Êõ¥Êñ∞';
            } else {
                title.textContent = '„Ç´„ÉÜ„Ç¥„É™ËøΩÂä†';
                nameInput.value = '';
                colorPicker.value = '#3b82f6';
                colorInput.value = '#3b82f6';
                saveBtn.textContent = 'ËøΩÂä†';
            }
            
            updateColorPalette();
            modal.classList.remove('hidden');
            nameInput.focus();
        }

        function closeModal() {
            document.getElementById('category-modal').classList.add('hidden');
            appState.editingCategory = null;
        }

        function updateColorPalette() {
            const palette = document.getElementById('color-palette');
            const currentColor = document.getElementById('color-picker').value;
            
            let html = '';
            presetColors.forEach(color => {
                const selected = color === currentColor ? 'selected' : '';
                html += `<div class="color-swatch ${selected}" style="background-color: ${color};" onclick="selectColor('${color}')"></div>`;
            });
            palette.innerHTML = html;
        }

        function selectColor(color) {
            document.getElementById('color-picker').value = color;
            document.getElementById('color-input').value = color;
            updateColorPalette();
        }

        function saveCategory() {
            const nameInput = document.getElementById('category-name-input');
            const colorInput = document.getElementById('color-input');
            
            const name = nameInput.value.trim();
            const color = colorInput.value;
            
            if (!name) {
                alert('„Ç´„ÉÜ„Ç¥„É™Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (appState.editingCategory) {
                // Á∑®ÈõÜ
                const index = appState.categories.findIndex(cat => cat.id === appState.editingCategory.id);
                if (index !== -1) {
                    appState.categories[index] = { ...appState.categories[index], name, color };
                }
            } else {
                // Êñ∞Ë¶èËøΩÂä†
                const newCategory = {
                    id: Date.now(),
                    name,
                    color
                };
                appState.categories.push(newCategory);
            }
            
            updateCategoryDropdown();
            updateSettingsScreen();
            closeModal();
        }

        function editCategory(id) {
            const category = getCategoryById(id);
            if (category) {
                openModal(true, category);
            }
        }

        function deleteCategory(id) {
            if (appState.categories.length <= 1) {
                alert('ÊúÄ‰Ωé1„Å§„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÅåÂøÖË¶Å„Åß„Åô');
                return;
            }
            
            if (confirm('„Åì„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                appState.categories = appState.categories.filter(cat => cat.id !== id);
                
                // ÈÅ∏Êäû‰∏≠„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÅåÂâäÈô§„Åï„Çå„ÅüÂ†¥Âêà„ÄÅÊúÄÂàù„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû
                if (appState.selectedCategory === id) {
                    appState.selectedCategory = appState.categories[0].id;
                }
                
                updateCategoryDropdown();
                updateSettingsScreen();
            }
        }

        function exportData() {
            if (appState.records.length === 0) {
                alert('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            const headers = ['Êó•‰ªò', '„Ç´„ÉÜ„Ç¥„É™', 'ÈñãÂßãÊôÇÈñì', 'ÁµÇ‰∫ÜÊôÇÈñì', 'ÊôÇÈñì(ÂàÜ)'];
            const rows = appState.records.map(record => {
                const category = getCategoryById(record.categoryId);
                return [
                    new Date(record.startTime).toLocaleDateString('ja-JP'),
                    category?.name || 'Unknown',
                    new Date(record.startTime).toLocaleTimeString('ja-JP'),
                    new Date(record.endTime).toLocaleTimeString('ja-JP'),
                    Math.round(record.duration / 60000)
                ];
            });
            
            const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'taptime_data.csv';
            link.click();
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
        function setupEventListeners() {
            // „Çø„Ç§„Éû„ÉºÊõ¥Êñ∞
            setInterval(updateCurrentTime, 1000);
            
            // „É°„Ç§„É≥„Éú„Çø„É≥
            document.getElementById('main-button').addEventListener('click', toggleRecording);
            
            // „Ç´„ÉÜ„Ç¥„É™„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥
            document.getElementById('category-dropdown-btn').addEventListener('click', () => {
                const dropdown = document.getElementById('category-dropdown');
                dropdown.classList.toggle('hidden');
            });
            
            // „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
            document.addEventListener('click', (e) => {
                const dropdown = document.getElementById('category-dropdown');
                const dropdownBtn = document.getElementById('category-dropdown-btn');
                if (!dropdown.contains(e.target) && !dropdownBtn.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });
            
            // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const screen = item.dataset.screen;
                    switchScreen(screen);
                });
            });
            
            // Áµ±Ë®àÁîªÈù¢„ÅÆÊó•‰ªò„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥
            document.getElementById('prev-day').addEventListener('click', () => {
                appState.viewDate = new Date(appState.viewDate.getTime() - 24*60*60*1000);
                updateStatsScreen();
            });
            
            document.getElementById('next-day').addEventListener('click', () => {
                const tomorrow = new Date(appState.viewDate.getTime() + 24*60*60*1000);
                if (tomorrow.toDateString() <= new Date().toDateString()) {
                    appState.viewDate = tomorrow;
                    updateStatsScreen();
                }
            });
            
            // „ÉÜ„Éº„ÉûÈÅ∏Êäû
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', () => {
                    setTheme(option.dataset.theme);
                });
            });

            // „Éï„Ç©„É≥„ÉàÈÅ∏Êäû
            document.querySelectorAll('.font-option').forEach(option => {
                option.addEventListener('click', () => {
                    setFont(option.dataset.font);
                });
            });

            // „Ç´„Çπ„Çø„É†ËÉåÊôØ„Éï„Ç°„Ç§„É´ÈÅ∏Êäû
            document.getElementById('custom-background').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    addCustomBackground(file);
                }
            });

            // Ê≤°ÂÖ•„É¢„Éº„Éâ„Ç™„Éº„Éê„Éº„É¨„Ç§„ÇØ„É™„ÉÉ„ÇØ
            document.getElementById('immersive-overlay').addEventListener('click', (e) => {
                console.log('„Ç™„Éº„Éê„Éº„É¨„Ç§„Åå„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü');
                exitImmersiveMode();
                if (appState.isRecording) {
                    console.log('5ÁßíÂæå„Å´ÂÜç„Å≥Ê≤°ÂÖ•„É¢„Éº„Éâ„Å´ÂÖ•„Çä„Åæ„Åô');
                    setImmersiveTimer();
                }
            });
            
            // „Éö„Éº„Ç∏„ÅÆË°®Á§∫Áä∂ÊÖãÂ§âÊõ¥„ÇíÁõ£Ë¶ñÔºà„Çø„ÉñÂàá„ÇäÊõø„ÅàÂØæÂøúÔºâ
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            // ÁîªÈù¢ÂÖ®‰Ωì„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„ÅßÊ≤°ÂÖ•„É¢„Éº„ÉâÁµÇ‰∫Ü
            document.addEventListener('click', (e) => {
                if (document.body.classList.contains('immersive-mode')) {
                    console.log('Ê≤°ÂÖ•„É¢„Éº„Éâ‰∏≠„Å´„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü');
                    exitImmersiveMode();
                    if (appState.isRecording) {
                        setImmersiveTimer();
                    }
                }
            });
            
            // „Ç≠„Éº„Éú„Éº„Éâ„ÅßÊ≤°ÂÖ•„É¢„Éº„ÉâÁµÇ‰∫Ü
            document.addEventListener('keydown', (e) => {
                if (document.body.classList.contains('immersive-mode')) {
                    console.log('Ê≤°ÂÖ•„É¢„Éº„Éâ‰∏≠„Å´„Ç≠„Éº„ÅåÊäº„Åï„Çå„Åæ„Åó„Åü');
                    exitImmersiveMode();
                    if (appState.isRecording) {
                        setImmersiveTimer();
                    }
                }
            });
            
            // Ë®≠ÂÆöÁîªÈù¢„ÅÆ„Éú„Çø„É≥
            document.getElementById('add-category-btn').addEventListener('click', () => openModal());
            document.getElementById('export-btn').addEventListener('click', exportData);
            
            // „É¢„Éº„ÉÄ„É´„ÅÆ„Éú„Çø„É≥
            document.getElementById('cancel-btn').addEventListener('click', closeModal);
            document.getElementById('save-btn').addEventListener('click', saveCategory);
            
            // „Ç´„É©„Éº„Éî„ÉÉ„Ç´„Éº„ÅÆÂêåÊúü
            document.getElementById('color-picker').addEventListener('change', (e) => {
                document.getElementById('color-input').value = e.target.value;
                updateColorPalette();
            });
            
            document.getElementById('color-input').addEventListener('input', (e) => {
                const color = e.target.value;
                if (/^#[0-9A-Fa-f]{6}$/.test(color)) {
                    document.getElementById('color-picker').value = color;
                    updateColorPalette();
                }
            });
            
            // „Ç´„ÉÜ„Ç¥„É™ÂêçÂÖ•Âäõ„Åß„ÅÆEnter„Ç≠„Éº
            document.getElementById('category-name-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    saveCategory();
                } else if (e.key === 'Escape') {
                    closeModal();
                }
            });
            
            // „É¢„Éº„ÉÄ„É´ËÉåÊôØ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
            document.getElementById('category-modal').addEventListener('click', (e) => {
                if (e.target.id === 'category-modal') {
                    closeModal();
                }
            });
            
            // PWAÁî®„ÅÆ„Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + Space „Åß„Çø„Ç§„Éû„ÉºÈñãÂßã/ÂÅúÊ≠¢
                if ((e.ctrlKey || e.metaKey) && e.code === 'Space') {
                    e.preventDefault();
                    if (appState.activeScreen === 'record') {
                        toggleRecording();
                    }
                }
                
                // Ctrl/Cmd + 1,2,3 „ÅßÁîªÈù¢Âàá„ÇäÊõø„Åà
                if ((e.ctrlKey || e.metaKey) && e.key >= '1' && e.key <= '3') {
                    e.preventDefault();
                    const screens = ['record', 'stats', 'settings'];
                    switchScreen(screens[parseInt(e.key) - 1]);
                }
            });
        }

        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñ
        function initApp() {
            // ‰øùÂ≠ò„Åï„Çå„ÅüË®≠ÂÆö„ÇíÈÅ©Áî®
            setTheme(appState.currentTheme);
            setFont(appState.currentFont);
            setBackground(appState.currentBackground);
            
            updateCurrentTime();
            updateCategoryDropdown();
            updateRecordingStatus();
            setupEventListeners();
            
            // PWAÁî®„ÅÆ„Çµ„Éº„Éì„Çπ„ÉØ„Éº„Ç´„ÉºÁôªÈå≤
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:text/javascript,');
            }
            
            // PWA„Ç§„É≥„Çπ„Éà„Éº„É´„Éó„É≠„É≥„Éó„Éà
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                setTimeout(() => {
                    if (confirm('TapTime„Çí„Éõ„Éº„É†ÁîªÈù¢„Å´ËøΩÂä†„Åó„Åæ„Åô„ÅãÔºü„Ç¢„Éó„É™„ÅÆ„Çà„ÅÜ„Å´‰ΩøÁî®„Åß„Åç„Åæ„Åô„ÄÇ')) {
                        e.prompt();
                    }
                }, 10000); // 10ÁßíÂæå„Å´Ë°®Á§∫
            });
        }

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÂÆå‰∫ÜÊôÇ„Å´ÂàùÊúüÂåñ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        // „Éö„Éº„Ç∏Èõ¢ËÑ±ÊôÇ„Å´„Éá„Éº„Çø„Çí‰øùÂ≠ò
        window.addEventListener('beforeunload', () => {
            localStorage.setItem('taptime-categories', JSON.stringify(appState.categories));
            localStorage.setItem('taptime-records', JSON.stringify(appState.records));
            localStorage.setItem('taptime-selected-category', appState.selectedCategory.toString());
        });

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´„Éá„Éº„Çø„ÇíÂæ©ÂÖÉ
        window.addEventListener('load', () => {
            try {
                const savedCategories = localStorage.getItem('taptime-categories');
                const savedRecords = localStorage.getItem('taptime-records');
                const savedSelectedCategory = localStorage.getItem('taptime-selected-category');
                
                if (savedCategories) {
                    appState.categories = JSON.parse(savedCategories);
                }
                
                if (savedRecords) {
                    appState.records = JSON.parse(savedRecords);
                }
                
                if (savedSelectedCategory) {
                    appState.selectedCategory = parseInt(savedSelectedCategory);
                }
                
                updateCategoryDropdown();
            } catch (error) {
                console.warn('„Éá„Éº„Çø„ÅÆÂæ©ÂÖÉ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
            }
        });
    </script>
</body>
</html>
            