<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TapTime - 時間管理アプリ</title>
    <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;TapTime&quot;,&quot;short_name&quot;:&quot;TapTime&quot;,&quot;description&quot;:&quot;タップするだけ、あなたの時間が見えてくる&quot;,&quot;start_url&quot;:&quot;/&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#ffffff&quot;,&quot;theme_color&quot;:&quot;#3b82f6&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%233b82f6'/%3E%3Ctext x='50' y='60' text-anchor='middle' fill='white' font-size='30' font-family='Arial'%3E⏰%3C/text%3E%3C/svg%3E&quot;,&quot;sizes&quot;:&quot;192x192&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;}]}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="TapTime">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=Noto+Sans+JP:wght@300;400;500;600;700&family=M+PLUS+Rounded+1c:wght@400;700;900&family=Klee+One:wght@400;600&family=Noto+Serif+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Light Theme (Default) */
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-gradient-start: #eff6ff;
            --bg-gradient-end: #e0e7ff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            --border-color: #d1d5db;
            --shadow-color: rgba(0,0,0,0.1);
            --card-bg: #ffffff;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --overlay-bg: rgba(0,0,0,0.5);
            --font-family: 'Noto Sans JP', sans-serif;
        }

        [data-theme="pastel-pink"] {
            --bg-primary: #fef7f7;
            --bg-secondary: #fdf2f2;
            --bg-gradient-start: #fef7f7;
            --bg-gradient-end: #fce7e7;
            --text-primary: #7c2d2d;
            --text-secondary: #a85252;
            --text-muted: #d87979;
            --border-color: #f4c2c2;
            --shadow-color: rgba(220, 96, 96, 0.1);
            --card-bg: #ffffff;
            --accent-color: #dc6060;
            --accent-hover: #c55555;
            --success-color: #34d399;
            --danger-color: #f87171;
            --overlay-bg: rgba(220, 96, 96, 0.5);
        }

        [data-theme="pastel-blue"] {
            --bg-primary: #f0f9ff;
            --bg-secondary: #e0f4ff;
            --bg-gradient-start: #f0f9ff;
            --bg-gradient-end: #dbeafe;
            --text-primary: #1e3a8a;
            --text-secondary: #3b82f6;
            --text-muted: #60a5fa;
            --border-color: #bfdbfe;
            --shadow-color: rgba(59, 130, 246, 0.1);
            --card-bg: #ffffff;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --success-color: #34d399;
            --danger-color: #f87171;
            --overlay-bg: rgba(59, 130, 246, 0.5);
        }

        [data-theme="pastel-green"] {
            --bg-primary: #f0fdf4;
            --bg-secondary: #e7fced;
            --bg-gradient-start: #f0fdf4;
            --bg-gradient-end: #dcfce7;
            --text-primary: #166534;
            --text-secondary: #16a34a;
            --text-muted: #4ade80;
            --border-color: #bbf7d0;
            --shadow-color: rgba(34, 197, 94, 0.1);
            --card-bg: #ffffff;
            --accent-color: #22c55e;
            --accent-hover: #16a34a;
            --success-color: #10b981;
            --danger-color: #f87171;
            --overlay-bg: rgba(34, 197, 94, 0.5);
        }

        [data-theme="pastel-purple"] {
            --bg-primary: #fef7ff;
            --bg-secondary: #fdf4ff;
            --bg-gradient-start: #fef7ff;
            --bg-gradient-end: #f3e8ff;
            --text-primary: #5b21b6;
            --text-secondary: #7c3aed;
            --text-muted: #a855f7;
            --border-color: #e9d5ff;
            --shadow-color: rgba(139, 92, 246, 0.1);
            --card-bg: #ffffff;
            --accent-color: #8b5cf6;
            --accent-hover: #7c3aed;
            --success-color: #34d399;
            --danger-color: #f87171;
            --overlay-bg: rgba(139, 92, 246, 0.5);
        }

        [data-theme="pastel-orange"] {
            --bg-primary: #fff7ed;
            --bg-secondary: #ffedd5;
            --bg-gradient-start: #fff7ed;
            --bg-gradient-end: #fed7aa;
            --text-primary: #9a3412;
            --text-secondary: #c2410c;
            --text-muted: #fb923c;
            --border-color: #fdba74;
            --shadow-color: rgba(249, 115, 22, 0.1);
            --card-bg: #ffffff;
            --accent-color: #f97316;
            --accent-hover: #ea580c;
            --success-color: #34d399;
            --danger-color: #f87171;
            --overlay-bg: rgba(249, 115, 22, 0.5);
        }

        [data-theme="pastel-yellow"] {
            --bg-primary: #fffbeb;
            --bg-secondary: #fef3c7;
            --bg-gradient-start: #fffbeb;
            --bg-gradient-end: #fde68a;
            --text-primary: #92400e;
            --text-secondary: #d97706;
            --text-muted: #f59e0b;
            --border-color: #fde68a;
            --shadow-color: rgba(245, 158, 11, 0.1);
            --card-bg: #ffffff;
            --accent-color: #f59e0b;
            --accent-hover: #d97706;
            --success-color: #34d399;
            --danger-color: #f87171;
            --overlay-bg: rgba(245, 158, 11, 0.5);
        }

        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-gradient-start: #111827;
            --bg-gradient-end: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --border-color: #374151;
            --shadow-color: rgba(0,0,0,0.3);
            --card-bg: #1f2937;
            --accent-color: #60a5fa;
            --accent-hover: #3b82f6;
            --success-color: #34d399;
            --danger-color: #f87171;
            --overlay-bg: rgba(0,0,0,0.7);
        }

        /* Font variants */
        [data-font="cute"] { --font-family: 'Kosugi Maru', sans-serif; }
        [data-font="simple"] { --font-family: 'Noto Sans JP', sans-serif; }
        [data-font="bold"] { --font-family: 'M PLUS Rounded 1c', sans-serif; }
        [data-font="handwrite"] { --font-family: 'Klee One', cursive; }
        [data-font="serif"] { --font-family: 'Noto Serif JP', serif; }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding-bottom: 80px;
            color: var(--text-primary);
            transition: all 0.3s ease;
            position: relative;
        }

        /* Enhanced Background System */
        .background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .background-video {
            position: absolute;
            top: 50%;
            left: 50%;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            transform: translate(-50%, -50%);
            opacity: 0.6;
            object-fit: cover;
        }

        .background-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.6;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .background-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.8;
            background-size: cover;
            background-position: center;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 25px var(--shadow-color);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5rem;
            color: var(--text-primary);
            margin-bottom: 10px;
            font-weight: 800;
            background: linear-gradient(45deg, var(--accent-color), var(--success-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .timer-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 25px var(--shadow-color);
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
        }

        .timer-display {
            text-align: center;
            margin-bottom: 30px;
        }

        .elapsed-time {
            font-size: 3.5rem;
            font-family: var(--font-family);
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 15px;
            text-shadow: 0 2px 4px var(--shadow-color);
            transition: all 0.5s ease;
        }

        /* タイマー画面専用スタイル */
        .timer-circle-container {
            position: relative;
            width: 280px;
            height: 280px;
            margin: 0 auto 30px;
        }

        .timer-circle {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .timer-circle-bg {
            stroke: var(--bg-secondary);
            stroke-width: 12;
            fill: none;
        }

        .timer-circle-progress {
            stroke: var(--accent-color);
            stroke-width: 12;
            fill: none;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.3s ease;
        }

        .timer-countdown {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            width: 200px;
        }

        .timer-countdown-time {
            font-size: 3rem;
            font-weight: bold;
            color: var(--text-primary);
            line-height: 1;
            display: block;
        }

        .timer-countdown-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 10px;
            display: block;
        }

        .timer-preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .timer-preset-item {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 15px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .timer-preset-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--shadow-color);
        }

        .timer-preset-item.active {
            border-color: var(--accent-color);
            background: var(--accent-color);
            color: white;
        }

        .timer-preset-emoji {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .timer-preset-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .timer-preset-time {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .timer-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }

        .timer-control-btn {
            flex: 1;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .timer-control-btn.primary {
            background: linear-gradient(45deg, var(--accent-color), var(--success-color));
            color: white;
        }

        .timer-control-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }

        .timer-control-btn.secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .timer-control-btn.secondary:hover {
            background: var(--border-color);
        }

        .timer-control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* タイマー完了モーダル */
        .timer-complete-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--overlay-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.3s ease;
        }

        .timer-complete-content {
            background: var(--card-bg);
            border-radius: 25px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            animation: bounceIn 0.5s ease;
        }

        .timer-complete-emoji {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: celebrate 1s ease infinite;
        }

        .timer-complete-title {
            font-size: 2rem;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 15px;
        }

        .timer-complete-message {
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .timer-complete-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(45deg, var(--accent-color), var(--success-color));
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .timer-complete-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }

        @keyframes celebrate {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(-5deg); }
            75% { transform: scale(1.1) rotate(5deg); }
        }

        @keyframes bounceIn {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* 没入モード - 共通 */
        body.immersive-mode .header,
        body.immersive-mode .category-select,
        body.immersive-mode .main-button,
        body.immersive-mode .recording-status,
        body.immersive-mode .current-time,
        body.immersive-mode .timer-preset-grid,
        body.immersive-mode .timer-controls,
        body.immersive-mode .custom-time-input,
        body.immersive-mode .timer-countdown-label {
            display: none !important;
        }

        body.immersive-mode .timer-card {
            background: transparent !important;
            box-shadow: none !important;
            border: none !important;
        }

        /* 記録画面の没入モード */
        body.immersive-mode #record-screen .timer-display {
            position: fixed !important;
            top: 50vh !important;
            left: 50% !important;
            transform: translateX(-50%) translateY(-55%) !important;
            z-index: 9999 !important;
            margin: 0 !important;
            width: 100vw !important;
            text-align: center !important;
        }

        body.immersive-mode #record-screen .elapsed-time {
            font-size: 5rem !important;
            color: rgba(255, 255, 255, 0.95) !important;
            text-shadow: 0 0 40px rgba(0, 0, 0, 0.9), 3px 3px 6px rgba(0, 0, 0, 0.8) !important;
        }

        /* タイマー画面の没入モード */
        body.immersive-mode #timer-screen .timer-circle-container {
            position: fixed !important;
            top: 50vh !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            z-index: 9999 !important;
            width: 350px !important;
            height: 350px !important;
        }

        body.immersive-mode #timer-screen .timer-countdown-time {
            font-size: 4rem !important;
            color: rgba(255, 255, 255, 0.95) !important;
            text-shadow: 0 0 40px rgba(0, 0, 0, 0.9), 3px 3px 6px rgba(0, 0, 0, 0.8) !important;
        }

        body.immersive-mode #timer-screen .timer-circle-progress {
            stroke: rgba(255, 255, 255, 0.9) !important;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.5));
        }

        body.immersive-mode #timer-screen .timer-circle-bg {
            stroke: rgba(255, 255, 255, 0.2) !important;
        }

        body.immersive-mode .navigation {
            display: none !important;
        }

        /* 没入モード用オーバーレイ */
        .immersive-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 5;
            cursor: pointer;
            display: none;
            background: transparent;
        }

        body.immersive-mode .immersive-overlay {
            display: block !important;
        }

        .current-time {
            font-size: 1.2rem;
            color: var(--text-secondary);
        }

        .category-select {
            margin-bottom: 30px;
        }

        .category-select label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .dropdown {
            position: relative;
            width: 100%;
        }

        .dropdown-button {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--card-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 1rem;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .dropdown-button:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .dropdown-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .dropdown-content {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 5px;
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            box-shadow: 0 10px 25px var(--shadow-color);
            z-index: 100;
            max-height: 240px;
            overflow-y: auto;
        }

        .dropdown-item {
            width: 100%;
            padding: 15px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: background 0.2s ease;
        }

        .dropdown-item:hover {
            background: var(--bg-secondary);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .color-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .main-button {
            width: 100%;
            padding: 20px;
            border: none;
            border-radius: 15px;
            font-size: 1.3rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            position: relative;
            overflow: hidden;
        }

        .main-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .main-button:hover::before {
            left: 100%;
        }

        .main-button.start {
            background: linear-gradient(45deg, var(--accent-color), var(--success-color));
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }

        .main-button.start:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(59, 130, 246, 0.4);
        }

        .main-button.stop {
            background: linear-gradient(45deg, var(--danger-color), #f97316);
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
        }

        .main-button.stop:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(239, 68, 68, 0.4);
        }

        .recording-status {
            margin-top: 15px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid var(--border-color);
        }

        .recording-status-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .navigation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            padding: 15px;
            backdrop-filter: blur(10px);
        }

        .nav-items {
            display: flex;
            justify-content: space-around;
            max-width: 480px;
            margin: 0 auto;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 10px 15px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }

        .nav-item.active {
            color: var(--accent-color);
            background: var(--bg-secondary);
        }

        .nav-item:hover {
            color: var(--text-primary);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            font-size: 1.2rem;
        }

        .nav-label {
            font-size: 0.75rem;
            font-weight: 600;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .stats-screen, .settings-screen {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .screen-title {
            font-size: 2rem;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 30px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px var(--shadow-color);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        /* Calendar styles */
        .calendar-container {
            margin-bottom: 30px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .month-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .month-nav button {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .month-nav button:hover {
            background: var(--bg-secondary);
            transform: scale(1.05);
        }

        .month-nav button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .month-year {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
            min-width: 150px;
            text-align: center;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: var(--border-color);
            border-radius: 10px;
            padding: 2px;
        }

        .calendar-day-header {
            background: var(--bg-secondary);
            padding: 10px 5px;
            text-align: center;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .calendar-day-header:first-child {
            border-radius: 8px 0 0 0;
        }

        .calendar-day-header:last-child {
            border-radius: 0 8px 0 0;
        }

        .calendar-day {
            background: var(--card-bg);
            padding: 8px 4px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .calendar-day:hover {
            background: var(--bg-secondary);
            transform: scale(1.02);
        }

        .calendar-day.other-month {
            opacity: 0.3;
            cursor: default;
        }

        .calendar-day.other-month:hover {
            background: var(--card-bg);
            transform: none;
        }

        .calendar-day.today {
            background: var(--accent-color);
            color: white;
        }

        .calendar-day.today:hover {
            background: var(--accent-hover);
        }

        .calendar-day.has-records {
            border: 2px solid var(--success-color);
        }

        .day-number {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .day-total {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-align: center;
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
            padding: 2px 4px;
        }

        .calendar-day.today .day-total {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        /* Detail view styles */
        .detail-view {
            display: none;
        }

        .detail-view.active {
            display: block;
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .back-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            cursor: pointer;
            color: var(--text-primary);
            transition: all 0.2s ease;
            font-family: var(--font-family);
            font-size: 1rem;
        }

        .back-button:hover {
            background: var(--bg-secondary);
            transform: translateX(-2px);
        }

        .detail-date {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stat-item {
            margin-bottom: 20px;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .stat-name {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stat-value {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .category-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .category-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .category-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .category-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 8px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 5px;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: var(--border-color);
            transform: scale(1.1);
        }

        .add-btn, .export-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .add-btn {
            background: linear-gradient(45deg, var(--accent-color), var(--success-color));
            color: white;
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }

        .export-btn {
            background: linear-gradient(45deg, var(--success-color), #06b6d4);
            color: white;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
        }

        /* Enhanced Theme Selector */
        .theme-selector {
            margin-bottom: 20px;
        }

        .theme-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .theme-option {
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            background: var(--card-bg);
        }

        .theme-option.active {
            border-color: var(--accent-color);
            background: var(--bg-secondary);
            transform: scale(1.05);
        }

        .theme-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--shadow-color);
        }

        .theme-preview {
            width: 100%;
            height: 40px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            overflow: hidden;
        }

        .theme-preview .color {
            flex: 1;
            height: 100%;
        }

        .theme-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        /* Font Selector */
        .font-selector {
            margin-bottom: 20px;
        }

        .font-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .font-option {
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            background: var(--card-bg);
        }

        .font-option.active {
            border-color: var(--accent-color);
            background: var(--bg-secondary);
        }

        .font-option:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px var(--shadow-color);
        }

        .font-sample {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .font-name {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Background Selector & Alarm Sound Selector */
        .background-selector, .alarm-selector {
            margin-bottom: 20px;
        }

        .background-options, .alarm-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .background-option, .alarm-option {
            position: relative;
            aspect-ratio: 16/9;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .alarm-option {
            aspect-ratio: 1/1;
        }

        .background-option.active, .alarm-option.active {
            border-color: var(--accent-color);
            transform: scale(1.05);
        }

        .background-option:hover, .alarm-option:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px var(--shadow-color);
        }

        .background-preview, .alarm-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .alarm-preview {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6);
        }

        .background-label, .alarm-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 4px;
            text-align: center;
            font-size: 0.65rem;
            font-weight: 500;
        }

        /* File Input for Custom Media */
        .file-input-container {
            margin-top: 15px;
            padding: 15px;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .file-input-container:hover {
            border-color: var(--accent-color);
            background: var(--bg-secondary);
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--overlay-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 40px var(--shadow-color);
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 25px;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--card-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .color-section {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .color-picker {
            width: 60px;
            height: 60px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            background: var(--card-bg);
        }

        .color-input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
        }

        .color-swatch {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .color-swatch:hover {
            transform: scale(1.1);
        }

        .color-swatch.selected {
            border-color: var(--text-primary);
            border-width: 3px;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--accent-color), var(--success-color));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .hidden {
            display: none !important;
        }

        .no-records {
            text-align: center;
            color: var(--text-muted);
            padding: 40px 20px;
        }

        .record-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
        }

        .record-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .record-details {
            flex: 1;
        }

        .record-category {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .record-time {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .record-duration {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* タイマープリセット管理 */
        .timer-preset-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .timer-preset-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .timer-preset-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .timer-preset-list-emoji {
            font-size: 1.5rem;
        }

        .timer-preset-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .timer-preset-list-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .timer-preset-list-time {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Custom Time Input */
        .custom-time-input {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .time-input-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .time-input {
            width: 60px;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            text-align: center;
            font-size: 1.1rem;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .time-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .time-input-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Animations */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .floating {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 0.6; }
        }

        .background-container.active {
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes countdown-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .timer-countdown.pulsing .timer-countdown-time {
            animation: countdown-pulse 1s ease-in-out infinite;
            color: var(--danger-color);
        }

        /* PWA specific styles */
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: calc(80px + env(safe-area-inset-bottom));
            }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .stats-screen .card {
                grid-column: 1;
            }
            
            .container {
                padding: 15px;
            }
            
            .theme-options {
                grid-template-columns: 1fr 1fr;
            }

            .font-options {
                grid-template-columns: 1fr;
            }

            .background-options {
                grid-template-columns: repeat(2, 1fr);
            }

            .timer-preset-grid {
                grid-template-columns: 1fr 1fr;
            }

            .nav-item {
                padding: 10px 10px;
            }
        }
    </style>
</head>
<body data-theme="light" data-font="cute">
    <div class="background-container" id="background-container">
        <!-- Dynamic background content will be inserted here -->
    </div>
    
    <div id="app">
        <!-- 記録画面 -->
        <div id="record-screen" class="screen active">
            <div class="container">
                <div class="header floating">
                    <h1>TapTime</h1>
                    <p>タップするだけ、あなたの時間が見えてくる</p>
                </div>

                <div class="timer-card">
                    <div class="timer-display">
                        <div id="elapsed-time" class="elapsed-time">00:00:00</div>
                        <div id="current-time" class="current-time"></div>
                    </div>

                    <div class="category-select">
                        <label>カテゴリ選択</label>
                        <div class="dropdown">
                            <button id="category-dropdown-btn" class="dropdown-button">
                                <div id="selected-category">
                                    <span class="color-dot" style="background-color: #3b82f6;"></span>
                                    <span>勉強</span>
                                </div>
                                <span>▼</span>
                            </button>
                            <div id="category-dropdown" class="dropdown-content hidden">
                                <!-- カテゴリオプションがここに動的に追加される -->
                            </div>
                        </div>
                    </div>

                    <button id="main-button" class="main-button start">
                        <span>▶</span>
                        <span>開始</span>
                    </button>

                    <div id="recording-status" class="recording-status hidden">
                        <span class="color-dot" style="background-color: #3b82f6;"></span>
                        <span class="recording-status-text">勉強 を記録中...</span>
                    </div>
                </div>

                <!-- Immersive mode overlay -->
                <div class="immersive-overlay" id="immersive-overlay"></div>
            </div>
        </div>

        <!-- タイマー画面 -->
        <div id="timer-screen" class="screen">
            <div class="container">
                <div class="timer-card">
                    <!-- タイマー円形表示 -->
                    <div class="timer-circle-container">
                        <svg class="timer-circle" viewBox="0 0 280 280">
                            <circle class="timer-circle-bg" cx="140" cy="140" r="130"></circle>
                            <circle class="timer-circle-progress" cx="140" cy="140" r="130"
                                    stroke-dasharray="816.8" stroke-dashoffset="816.8"></circle>
                        </svg>
                        <div class="timer-countdown">
                            <div id="timer-countdown-time" class="timer-countdown-time">00:00</div>
                            <div id="timer-countdown-label" class="timer-countdown-label">タイマーを選択</div>
                        </div>
                    </div>

                    <!-- コントロールボタン -->
                    <div class="timer-controls">
                        <button id="timer-start-btn" class="timer-control-btn primary">
                            <span>▶</span>
                            <span>開始</span>
                        </button>
                        <button id="timer-reset-btn" class="timer-control-btn secondary">
                            <span>↻</span>
                            <span>リセット</span>
                        </button>
                    </div>

                    <!-- プリセット選択 -->
                    <div class="timer-preset-grid" id="timer-preset-grid">
                        <!-- プリセットがここに動的に追加される -->
                    </div>

                    <!-- カスタム時間入力 -->
                    <div class="custom-time-input">
                        <div class="time-input-group">
                            <input type="number" id="custom-minutes" class="time-input" min="0" max="99" value="25">
                            <span class="time-input-label">分</span>
                        </div>
                        <div class="time-input-group">
                            <input type="number" id="custom-seconds" class="time-input" min="0" max="59" value="0">
                            <span class="time-input-label">秒</span>
                        </div>
                        <button class="timer-control-btn secondary" style="flex: none; padding: 8px 15px;" onclick="setCustomTime()">
                            セット
                        </button>
                    </div>
                </div>

                <!-- Immersive mode overlay for timer -->
                <div class="immersive-overlay" id="timer-immersive-overlay"></div>
            </div>
        </div>

        <!-- 統計画面 -->
        <div id="stats-screen" class="screen">
            <div class="stats-screen">
                <h2 class="screen-title">統計</h2>

                <!-- カレンダービュー -->
                <div id="calendar-view" class="calendar-view">
                    <div class="card">
                        <div class="calendar-container">
                            <div class="calendar-header">
                                <div class="month-nav">
                                    <button id="prev-month">‹</button>
                                    <div id="current-month" class="month-year"></div>
                                    <button id="next-month">›</button>
                                </div>
                            </div>
                            <div class="calendar-grid" id="calendar-grid">
                                <!-- カレンダーがここに動的に生成される -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 詳細ビュー -->
                <div id="detail-view" class="detail-view">
                    <div class="detail-header">
                        <button id="back-to-calendar" class="back-button">
                            <span>←</span>
                            <span>カレンダーに戻る</span>
                        </button>
                        <div id="detail-date" class="detail-date"></div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr; gap: 20px;">
                        <div class="card">
                            <h3 class="card-title">カテゴリ別時間</h3>
                            <div id="detail-category-stats">
                                <div class="no-records">この日の記録はありません</div>
                            </div>
                        </div>

                        <div class="card">
                            <h3 class="card-title">記録一覧</h3>
                            <div id="detail-record-list" class="record-list">
                                <div class="no-records">この日の記録はありません</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 設定画面 -->
        <div id="settings-screen" class="screen">
            <div class="settings-screen">
                <h2 class="screen-title">設定</h2>

                <!-- テーマ設定 -->
                <div class="card">
                    <h3 class="card-title">外観設定</h3>
                    
                    <div class="theme-selector">
                        <label class="form-label">カラーテーマ</label>
                        <div class="theme-options">
                            <div class="theme-option active" data-theme="light">
                                <div class="theme-preview">
                                    <div class="color" style="background: #eff6ff;"></div>
                                    <div class="color" style="background: #3b82f6;"></div>
                                    <div class="color" style="background: #ffffff;"></div>
                                </div>
                                <div class="theme-name">ライト</div>
                            </div>
                            
                            <div class="theme-option" data-theme="dark">
                                <div class="theme-preview">
                                    <div class="color" style="background: #111827;"></div>
                                    <div class="color" style="background: #60a5fa;"></div>
                                    <div class="color" style="background: #1f2937;"></div>
                                </div>
                                <div class="theme-name">ダーク</div>
                            </div>
                            
                            <div class="theme-option" data-theme="pastel-pink">
                                <div class="theme-preview">
                                    <div class="color" style="background: #fef7f7;"></div>
                                    <div class="color" style="background: #dc6060;"></div>
                                    <div class="color" style="background: #fce7e7;"></div>
                                </div>
                                <div class="theme-name">パステルピンク</div>
                            </div>

                            <div class="theme-option" data-theme="pastel-blue">
                                <div class="theme-preview">
                                    <div class="color" style="background: #f0f9ff;"></div>
                                    <div class="color" style="background: #3b82f6;"></div>
                                    <div class="color" style="background: #dbeafe;"></div>
                                </div>
                                <div class="theme-name">パステルブルー</div>
                            </div>

                            <div class="theme-option" data-theme="pastel-green">
                                <div class="theme-preview">
                                    <div class="color" style="background: #f0fdf4;"></div>
                                    <div class="color" style="background: #22c55e;"></div>
                                    <div class="color" style="background: #dcfce7;"></div>
                                </div>
                                <div class="theme-name">パステルグリーン</div>
                            </div>

                            <div class="theme-option" data-theme="pastel-purple">
                                <div class="theme-preview">
                                    <div class="color" style="background: #fef7ff;"></div>
                                    <div class="color" style="background: #8b5cf6;"></div>
                                    <div class="color" style="background: #f3e8ff;"></div>
                                </div>
                                <div class="theme-name">パステルパープル</div>
                            </div>

                            <div class="theme-option" data-theme="pastel-orange">
                                <div class="theme-preview">
                                    <div class="color" style="background: #fff7ed;"></div>
                                    <div class="color" style="background: #f97316;"></div>
                                    <div class="color" style="background: #fed7aa;"></div>
                                </div>
                                <div class="theme-name">パステルオレンジ</div>
                            </div>
                            <div class="theme-option" data-theme="pastel-yellow">
                                <div class="theme-preview">
                                    <div class="color" style="background: #fffbeb;"></div>
                                    <div class="color" style="background: #f59e0b;"></div>
                                    <div class="color" style="background: #fde68a;"></div>
                                </div>
                                <div class="theme-name">パステルイエロー</div>
                            </div>
                        </div>
                    </div>

                    <div class="font-selector">
                        <label class="form-label">フォント</label>
                        <div class="font-options">
                            <div class="font-option active" data-font="cute">
                                <div class="font-sample" style="font-family: 'Kosugi Maru', sans-serif;">時間を計る</div>
                                <div class="font-name">かわいい系</div>
                            </div>
                            <div class="font-option" data-font="simple">
                                <div class="font-sample" style="font-family: 'Noto Sans JP', sans-serif;">時間を計る</div>
                                <div class="font-name">シンプル</div>
                            </div>
                            <div class="font-option" data-font="bold">
                                <div class="font-sample" style="font-family: 'M PLUS Rounded 1c', sans-serif; font-weight: 900;">時間を計る</div>
                                <div class="font-name">太い</div>
                            </div>
                            <div class="font-option" data-font="handwrite">
                                <div class="font-sample" style="font-family: 'Klee One', cursive;">時間を計る</div>
                                <div class="font-name">手書き風</div>
                            </div>
                            <div class="font-option" data-font="serif">
                                <div class="font-sample" style="font-family: 'Noto Serif JP', serif;">時間を計る</div>
                                <div class="font-name">明朝</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 背景設定 -->
                <div class="card">
                    <h3 class="card-title">背景設定</h3>
                    
                    <div class="background-selector">
                        <label class="form-label">背景を選択</label>
                        <div class="background-options" id="background-options">
                            <div class="background-option active" data-bg="none">
                                <div class="background-preview" style="background: linear-gradient(45deg, #f0f9ff, #e0e7ff);"></div>
                                <div class="background-label">なし</div>
                            </div>
                        </div>
                        
                        <div class="file-input-container">
                            <input type="file" id="custom-background" class="file-input" accept="video/*,image/*,.gif">
                            <label for="custom-background" class="file-input-label">
                                📁 カスタム背景をアップロード<br>
                                <small>動画、画像、GIFファイルに対応</small>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- タイマープリセット管理 -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 class="card-title" style="margin-bottom: 0;">タイマープリセット</h3>
                        <button id="add-timer-preset-btn" class="add-btn">
                            <span>+</span>
                            <span>追加</span>
                        </button>
                    </div>
                    <div id="timer-preset-list" class="timer-preset-list">
                        <!-- タイマープリセットがここに動的に追加される -->
                    </div>
                </div>

                <!-- アラーム音設定 -->
                <div class="card">
                    <h3 class="card-title">アラーム音設定</h3>
                    
                    <div class="alarm-selector">
                        <label class="form-label">アラーム音を選択</label>
                        <div class="alarm-options" id="alarm-sound-options">
                            <div class="alarm-option active" data-sound="default">
                                <div class="alarm-preview">
                                    🔔
                                </div>
                                <div class="alarm-label">デフォルト</div>
                            </div>
                        </div>
                        
                        <div class="file-input-container">
                            <input type="file" id="custom-alarm-sound" class="file-input" accept="audio/*,.mp3,.wav,.ogg,.m4a">
                            <label for="custom-alarm-sound" class="file-input-label">
                                🎵 カスタムアラーム音をアップロード<br>
                                <small>MP3、WAV、OGG、M4Aなど（最大50MB）</small>
                            </label>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <button id="test-alarm-btn" class="btn btn-secondary" style="width: 100%;">
                                🔊 アラーム音をテスト
                            </button>
                        </div>
                    </div>
                </div>

                <!-- カテゴリ管理 -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 class="card-title" style="margin-bottom: 0;">カテゴリ管理</h3>
                        <button id="add-category-btn" class="add-btn">
                            <span>+</span>
                            <span>追加</span>
                        </button>
                    </div>
                    <div id="category-list" class="category-list">
                        <!-- カテゴリがここに動的に追加される -->
                    </div>
                </div>

                <!-- データ管理 -->
                <div class="card">
                    <h3 class="card-title">データ管理</h3>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div>
                            <button id="export-btn" class="export-btn">
                                <span>📥</span>
                                <span>CSVエクスポート</span>
                            </button>
                            <p style="margin-top: 10px; font-size: 0.9rem; color: var(--text-secondary);">
                                記録データをCSVファイルとしてダウンロードします
                            </p>
                        </div>
                        
                        <div>
                            <input type="file" id="import-input" class="file-input" accept=".csv" style="display: none;">
                            <button id="import-btn" class="add-btn">
                                <span>📤</span>
                                <span>CSVインポート</span>
                            </button>
                            <p style="margin-top: 10px; font-size: 0.9rem; color: var(--text-secondary);">
                                CSVファイルから記録データを読み込みます<br>
                                <small>※既存データは保持されます</small>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ナビゲーション -->
    <div class="navigation">
        <div class="nav-items">
            <button class="nav-item active" data-screen="record">
                <div class="nav-icon">⏱️</div>
                <div class="nav-label">記録</div>
            </button>
            <button class="nav-item" data-screen="timer">
                <div class="nav-icon">⏰</div>
                <div class="nav-label">タイマー</div>
            </button>
            <button class="nav-item" data-screen="stats">
                <div class="nav-icon">📊</div>
                <div class="nav-label">統計</div>
            </button>
            <button class="nav-item" data-screen="settings">
                <div class="nav-icon">⚙️</div>
                <div class="nav-label">設定</div>
            </button>
        </div>
    </div>

    <!-- カテゴリモーダル -->
    <div id="category-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="modal-title">カテゴリ追加</h3>
            
            <div class="form-group">
                <label class="form-label">カテゴリ名</label>
                <input type="text" id="category-name-input" class="form-input" placeholder="カテゴリ名を入力">
            </div>

            <div class="form-group">
                <label class="form-label">カラー</label>
                <div class="color-section">
                    <input type="color" id="color-picker" class="color-picker" value="#3b82f6">
                    <input type="text" id="color-input" class="color-input" value="#3b82f6" placeholder="#3b82f6">
                </div>
                <div class="color-palette" id="color-palette">
                    <!-- プリセットカラーがここに追加される -->
                </div>
            </div>

            <div class="modal-buttons">
                <button id="cancel-btn" class="btn btn-secondary">キャンセル</button>
                <button id="save-btn" class="btn btn-primary">追加</button>
            </div>
        </div>
    </div>

    <!-- タイマープリセットモーダル -->
    <div id="timer-preset-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="timer-modal-title" class="modal-title">タイマープリセット追加</h3>
            
            <div class="form-group">
                <label class="form-label">プリセット名</label>
                <input type="text" id="timer-preset-name-input" class="form-input" placeholder="例: ポモドーロ">
            </div>

            <div class="form-group">
                <label class="form-label">絵文字</label>
                <input type="text" id="timer-preset-emoji-input" class="form-input" placeholder="例: 🍅" maxlength="2">
            </div>

            <div class="form-group">
                <label class="form-label">時間設定</label>
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <input type="number" id="timer-preset-minutes-input" class="form-input" placeholder="分" min="0" max="99">
                    </div>
                    <div style="flex: 1;">
                        <input type="number" id="timer-preset-seconds-input" class="form-input" placeholder="秒" min="0" max="59">
                    </div>
                </div>
            </div>

            <div class="modal-buttons">
                <button id="timer-cancel-btn" class="btn btn-secondary">キャンセル</button>
                <button id="timer-save-btn" class="btn btn-primary">追加</button>
            </div>
        </div>
    </div>

    <!-- タイマー完了モーダル -->
    <div id="timer-complete-modal" class="timer-complete-modal hidden">
        <div class="timer-complete-content">
            <div class="timer-complete-emoji">🎉</div>
            <h2 class="timer-complete-title">お疲れ様でした！</h2>
            <p class="timer-complete-message">
                <span id="completed-timer-name">タイマー</span>が完了しました！<br>
                素晴らしい集中力でした✨
            </p>
            <button class="timer-complete-btn" onclick="closeTimerCompleteModal()">
                🛑 アラームを停止
            </button>
        </div>
    </div>

    <script>
        // アプリケーションの状態
        let appState = {
            currentTime: new Date(),
            isRecording: false,
            recordingStart: null,
            elapsedTime: 0,
            selectedCategory: 1,
            activeScreen: 'record',
            categories: [
                { id: 1, name: '勉強', color: '#3b82f6' },
                { id: 2, name: '仕事', color: '#10b981' },
                { id: 3, name: '読書', color: '#8b5cf6' },
                { id: 4, name: '運動', color: '#f59e0b' },
                { id: 5, name: 'タイマー集中', color: '#ec4899' }  // タイマー用カテゴリを追加
            ],
            records: [],
            viewDate: new Date(),
            calendarDate: new Date(),
            showingDetailView: false,
            detailViewDate: null,
            editingCategory: null,
            currentTheme: localStorage.getItem('taptime-theme') || 'light',
            currentFont: localStorage.getItem('taptime-font') || 'cute',
            currentBackground: localStorage.getItem('taptime-background') || 'none',
            customBackgrounds: JSON.parse(localStorage.getItem('taptime-custom-backgrounds') || '[]'),
            immersiveTimeout: null,
            // タイマー関連の状態
            timerPresets: [
                { id: 1, name: 'ポモドーロ', emoji: '🍅', minutes: 25, seconds: 0 },
                { id: 2, name: '短い休憩', emoji: '☕', minutes: 5, seconds: 0 },
                { id: 3, name: '長い休憩', emoji: '🌴', minutes: 15, seconds: 0 },
                { id: 4, name: '瞑想', emoji: '🧘', minutes: 10, seconds: 0 },
                { id: 5, name: 'パワーナップ', emoji: '😴', minutes: 20, seconds: 0 },
                { id: 6, name: 'クイック集中', emoji: '⚡', minutes: 2, seconds: 0 }
            ],
            selectedTimerPreset: null,
            timerState: 'idle', // idle, running, paused
            timerDuration: 0, // in milliseconds
            timerRemaining: 0, // in milliseconds
            timerInterval: null,
            timerStartTime: null,
            timerActualStartTime: null, // タイマー開始時刻（記録用）
            editingTimerPreset: null,
            timerImmersiveTimeout: null,
            audioContext: null,
            alarmPlayed: false,
            // アラーム音関連
            alarmSound: localStorage.getItem('taptime-alarm-sound') || 'default',
            customAlarmSounds: JSON.parse(localStorage.getItem('taptime-custom-alarm-sounds') || '[]'),
            currentAlarmAudio: null,
            alarmInterval: null
        };

        // プリセットカラー
        const presetColors = [
            '#3b82f6', '#10b981', '#8b5cf6', '#f59e0b',
            '#ef4444', '#06b6d4', '#84cc16', '#f97316',
            '#ec4899', '#6366f1', '#14b8a6', '#eab308',
            '#dc2626', '#0891b2', '#65a30d', '#ea580c'
        ];

        // プリセット背景
        const presetBackgrounds = [
            {
                id: 'lofi-study-1',
                name: 'LoFi勉強部屋',
                type: 'image',
                url: './lofi-study-1.gif'
            },
            {
                id: 'lofi-night-room',
                name: 'LoFi夜の部屋',
                type: 'image', 
                url: './lofi-night-room.gif'
            },
            {
                id: 'lofi-cyber-room',
                name: 'LoFiサイバー部屋', 
                type: 'image',
                url: './lofi-cyber-room.gif'
            }
        ];

        // アラーム音を再生する関数
        function playAlarmSound() {
            if (appState.alarmPlayed) return;
            appState.alarmPlayed = true;

            stopAlarmSound(); // 既存の音を停止

            if (appState.alarmSound === 'default') {
                // デフォルトのビープ音（Web Audio API）
                if (!appState.audioContext) {
                    appState.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const playBeep = () => {
                    if (!appState.alarmPlayed) return;
                    
                    const ctx = appState.audioContext;
                    const oscillator = ctx.createOscillator();
                    const gainNode = ctx.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(ctx.destination);
                    
                    oscillator.frequency.setValueAtTime(800, ctx.currentTime);
                    gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                    
                    oscillator.start(ctx.currentTime);
                    oscillator.stop(ctx.currentTime + 0.2);
                };

                // 繰り返し再生
                playBeep();
                appState.alarmInterval = setInterval(() => {
                    if (appState.alarmPlayed) {
                        playBeep();
                    } else {
                        clearInterval(appState.alarmInterval);
                    }
                }, 500);
                
            } else {
                // カスタムアラーム音
                const customSound = appState.customAlarmSounds.find(s => s.id === appState.alarmSound);
                if (customSound) {
                    appState.currentAlarmAudio = new Audio(customSound.url);
                    appState.currentAlarmAudio.loop = true;
                    appState.currentAlarmAudio.volume = 0.5;
                    appState.currentAlarmAudio.play().catch(e => {
                        console.error('Failed to play alarm sound:', e);
                        // フォールバック: デフォルト音を再生
                        appState.alarmSound = 'default';
                        playAlarmSound();
                    });
                }
            }
            
            // バイブレーション（対応している場合）
            if ('vibrate' in navigator) {
                const vibratePattern = [200, 100, 200, 100, 200];
                navigator.vibrate(vibratePattern);
                // 繰り返しバイブレーション
                appState.vibrateInterval = setInterval(() => {
                    if (appState.alarmPlayed) {
                        navigator.vibrate(vibratePattern);
                    } else {
                        clearInterval(appState.vibrateInterval);
                    }
                }, 2000);
            }
        }

        function stopAlarmSound() {
            appState.alarmPlayed = false;
            
            // 音を停止
            if (appState.currentAlarmAudio) {
                appState.currentAlarmAudio.pause();
                appState.currentAlarmAudio.currentTime = 0;
                appState.currentAlarmAudio = null;
            }
            
            // インターバルをクリア
            if (appState.alarmInterval) {
                clearInterval(appState.alarmInterval);
                appState.alarmInterval = null;
            }
            
            // バイブレーションを停止
            if ('vibrate' in navigator) {
                navigator.vibrate(0);
                if (appState.vibrateInterval) {
                    clearInterval(appState.vibrateInterval);
                    appState.vibrateInterval = null;
                }
            }
        }

        // タイマー関連の関数
        function updateTimerPresetGrid() {
            const grid = document.getElementById('timer-preset-grid');
            if (!grid) return;
            
            let html = '';
            appState.timerPresets.forEach(preset => {
                const isActive = appState.selectedTimerPreset?.id === preset.id;
                html += `
                    <div class="timer-preset-item ${isActive ? 'active' : ''}" onclick="selectTimerPreset(${preset.id})">
                        <div class="timer-preset-emoji">${preset.emoji}</div>
                        <div class="timer-preset-name">${preset.name}</div>
                        <div class="timer-preset-time">${preset.minutes}分${preset.seconds > 0 ? preset.seconds + '秒' : ''}</div>
                    </div>
                `;
            });
            grid.innerHTML = html;
        }

        function selectTimerPreset(presetId) {
            if (appState.timerState === 'running') return;
            
            const preset = appState.timerPresets.find(p => p.id === presetId);
            if (preset) {
                appState.selectedTimerPreset = preset;
                appState.timerDuration = (preset.minutes * 60 + preset.seconds) * 1000;
                appState.timerRemaining = appState.timerDuration;
                appState.timerState = 'idle'; // リセット状態にする
                updateTimerDisplay();
                updateTimerPresetGrid();
                updateTimerControls(); // ボタンの状態を更新
            }
        }

        function setCustomTime() {
            if (appState.timerState === 'running') return;
            
            const minutes = parseInt(document.getElementById('custom-minutes').value) || 0;
            const seconds = parseInt(document.getElementById('custom-seconds').value) || 0;
            
            if (minutes === 0 && seconds === 0) {
                alert('時間を設定してください');
                return;
            }
            
            appState.selectedTimerPreset = {
                id: 'custom',
                name: 'カスタム',
                emoji: '⏱️',
                minutes: minutes,
                seconds: seconds
            };
            
            appState.timerDuration = (minutes * 60 + seconds) * 1000;
            appState.timerRemaining = appState.timerDuration;
            appState.timerState = 'idle'; // リセット状態にする
            updateTimerDisplay();
            updateTimerPresetGrid();
            updateTimerControls(); // ボタンの状態を更新
        }

        function updateTimerDisplay() {
            const timeDisplay = document.getElementById('timer-countdown-time');
            const label = document.getElementById('timer-countdown-label');
            const circle = document.querySelector('.timer-circle-progress');
            
            if (!timeDisplay || !circle) return;
            
            const totalSeconds = Math.ceil(appState.timerRemaining / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            
            timeDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (appState.selectedTimerPreset) {
                label.textContent = appState.selectedTimerPreset.name;
            } else {
                label.textContent = 'タイマーを選択';
            }
            
            // 円形プログレスバーの更新
            const circumference = 2 * Math.PI * 130; // 円周
            const progress = appState.timerDuration > 0 ? appState.timerRemaining / appState.timerDuration : 1;
            const offset = circumference * (1 - progress);
            
            circle.style.strokeDasharray = circumference;
            circle.style.strokeDashoffset = offset;
            
            // 残り時間が少なくなったらパルスアニメーション（5秒以下）
            const countdown = document.querySelector('.timer-countdown');
            if (totalSeconds <= 5 && totalSeconds > 0 && appState.timerState === 'running') {
                countdown.classList.add('pulsing');
            } else {
                countdown.classList.remove('pulsing');
            }
        }

        function startTimer() {
            if (!appState.selectedTimerPreset || appState.timerRemaining <= 0) {
                alert('タイマーを設定してください');
                return;
            }
            
            appState.timerState = 'running';
            appState.timerStartTime = Date.now() - (appState.timerDuration - appState.timerRemaining);
            appState.timerActualStartTime = Date.now(); // 実際の開始時刻を記録
            appState.alarmPlayed = false;
            
            updateTimerControls();
            
            // タイマー更新
            appState.timerInterval = setInterval(() => {
                const elapsed = Date.now() - appState.timerStartTime;
                appState.timerRemaining = Math.max(0, appState.timerDuration - elapsed);
                
                updateTimerDisplay();
                
                if (appState.timerRemaining === 0) {
                    completeTimer();
                }
            }, 100);
            
            // 没入モードタイマー設定
            setTimerImmersiveTimer();
        }

        function pauseTimer() {
            if (appState.timerState !== 'running') return;
            
            appState.timerState = 'paused';
            clearInterval(appState.timerInterval);
            updateTimerControls();
            
            // 没入モードクリア
            clearTimerImmersiveTimer();
        }

        function resumeTimer() {
            if (appState.timerState !== 'paused') return;
            
            appState.timerState = 'running';
            appState.timerStartTime = Date.now() - (appState.timerDuration - appState.timerRemaining);
            
            appState.timerInterval = setInterval(() => {
                const elapsed = Date.now() - appState.timerStartTime;
                appState.timerRemaining = Math.max(0, appState.timerDuration - elapsed);
                
                updateTimerDisplay();
                
                if (appState.timerRemaining === 0) {
                    completeTimer();
                }
            }, 100);
            
            updateTimerControls();
            setTimerImmersiveTimer();
        }

        function resetTimer() {
            // タイマーが実行中だった場合、途中終了として記録
            if ((appState.timerState === 'running' || appState.timerState === 'paused') && appState.timerActualStartTime) {
                const actualDuration = Date.now() - appState.timerActualStartTime;
                if (actualDuration > 5000) { // 5秒以上なら記録
                    saveTimerRecord(actualDuration, false);
                    // カレンダービューを更新
                    if (appState.activeScreen === 'stats') {
                        if (appState.showingDetailView) {
                            showDetailView(appState.detailViewDate);
                        } else {
                            updateCalendar();
                        }
                    }
                }
            }
            
            appState.timerState = 'idle';
            appState.timerActualStartTime = null;
            clearInterval(appState.timerInterval);
            
            if (appState.selectedTimerPreset) {
                appState.timerRemaining = appState.timerDuration;
            } else {
                appState.timerRemaining = 0;
            }
            
            updateTimerDisplay();
            updateTimerControls();
            clearTimerImmersiveTimer();
        }

        function completeTimer() {
            const actualDuration = Date.now() - appState.timerActualStartTime;
            
            appState.timerState = 'idle';
            clearInterval(appState.timerInterval);
            clearTimerImmersiveTimer();
            
            // タイマー記録を保存
            saveTimerRecord(actualDuration, true);
            
            // アラーム音を鳴らす
            playAlarmSound();
            
            // 完了モーダルを表示
            const modal = document.getElementById('timer-complete-modal');
            const nameSpan = document.getElementById('completed-timer-name');
            
            if (appState.selectedTimerPreset) {
                nameSpan.textContent = `${appState.selectedTimerPreset.emoji} ${appState.selectedTimerPreset.name}`;
            }
            
            modal.classList.remove('hidden');
            
            // リセット
            appState.timerRemaining = appState.timerDuration;
            updateTimerDisplay();
            updateTimerControls();
            
            // カレンダービューを更新（統計画面の場合）
            if (appState.activeScreen === 'stats') {
                if (appState.showingDetailView) {
                    showDetailView(appState.detailViewDate);
                } else {
                    updateCalendar();
                }
            }
        }

        function saveTimerRecord(duration, completed) {
            // タイマー集中カテゴリを取得または作成
            let timerCategory = appState.categories.find(cat => cat.name === 'タイマー集中');
            if (!timerCategory) {
                timerCategory = {
                    id: 'timer-category-' + Date.now(),
                    name: 'タイマー集中',
                    color: '#ec4899'
                };
                appState.categories.push(timerCategory);
                // カテゴリドロップダウンを更新
                updateCategoryDropdown();
            }
            
            const endTime = Date.now();
            const startTime = endTime - duration;
            
            const timerName = appState.selectedTimerPreset ? 
                `${appState.selectedTimerPreset.emoji} ${appState.selectedTimerPreset.name}` : 
                'タイマー';
            
            const newRecord = {
                id: Date.now() + Math.random(),
                categoryId: timerCategory.id,
                startTime: startTime,
                endTime: endTime,
                duration: duration,
                date: new Date(startTime).toDateString(),
                note: completed ? `${timerName} 完了` : `${timerName} 途中終了`,
                isTimer: true
            };
            
            appState.records.push(newRecord);
            
            // ローカルストレージに保存
            try {
                localStorage.setItem('taptime-records', JSON.stringify(appState.records));
                localStorage.setItem('taptime-categories', JSON.stringify(appState.categories));
                console.log('Timer record saved:', newRecord);
            } catch (e) {
                console.error('Failed to save timer record:', e);
            }
        }

        function closeTimerCompleteModal() {
            document.getElementById('timer-complete-modal').classList.add('hidden');
            stopAlarmSound(); // アラーム音を停止
        }

        function updateTimerControls() {
            const startBtn = document.getElementById('timer-start-btn');
            const resetBtn = document.getElementById('timer-reset-btn');
            
            if (!startBtn || !resetBtn) return;
            
            // 既存のイベントリスナーを削除して新しく設定
            const newStartBtn = startBtn.cloneNode(true);
            startBtn.parentNode.replaceChild(newStartBtn, startBtn);
            
            switch (appState.timerState) {
                case 'idle':
                    newStartBtn.innerHTML = '<span>▶</span><span>開始</span>';
                    newStartBtn.onclick = startTimer;
                    newStartBtn.disabled = !appState.selectedTimerPreset;
                    resetBtn.disabled = false;
                    break;
                case 'running':
                    newStartBtn.innerHTML = '<span>⏸</span><span>一時停止</span>';
                    newStartBtn.onclick = pauseTimer;
                    newStartBtn.disabled = false;
                    resetBtn.disabled = false;
                    break;
                case 'paused':
                    newStartBtn.innerHTML = '<span>▶</span><span>再開</span>';
                    newStartBtn.onclick = resumeTimer;
                    newStartBtn.disabled = false;
                    resetBtn.disabled = false;
                    break;
            }
        }

        // タイマー画面の没入モード
        function setTimerImmersiveTimer() {
            if (appState.timerImmersiveTimeout) {
                clearTimeout(appState.timerImmersiveTimeout);
            }
            
            if (appState.timerState === 'running' && appState.activeScreen === 'timer') {
                appState.timerImmersiveTimeout = setTimeout(() => {
                    if (appState.timerState === 'running' && appState.activeScreen === 'timer') {
                        enterImmersiveMode();
                    }
                }, 5000);
            }
        }

        function clearTimerImmersiveTimer() {
            if (appState.timerImmersiveTimeout) {
                clearTimeout(appState.timerImmersiveTimeout);
                appState.timerImmersiveTimeout = null;
            }
            if (appState.activeScreen === 'timer') {
                exitImmersiveMode();
            }
        }

        // タイマープリセット管理
        function updateTimerPresetList() {
            const list = document.getElementById('timer-preset-list');
            if (!list) return;
            
            let html = '';
            appState.timerPresets.forEach(preset => {
                html += `
                    <div class="timer-preset-list-item">
                        <div class="timer-preset-info">
                            <div class="timer-preset-list-emoji">${preset.emoji}</div>
                            <div class="timer-preset-details">
                                <div class="timer-preset-list-name">${preset.name}</div>
                                <div class="timer-preset-list-time">${preset.minutes}分${preset.seconds > 0 ? preset.seconds + '秒' : ''}</div>
                            </div>
                        </div>
                        <div class="category-actions">
                            <button class="action-btn" onclick="editTimerPreset(${preset.id})">✏️</button>
                            <button class="action-btn" onclick="deleteTimerPreset(${preset.id})" ${appState.timerPresets.length <= 1 ? 'disabled' : ''}>🗑️</button>
                        </div>
                    </div>
                `;
            });
            list.innerHTML = html;
        }

        function openTimerPresetModal(isEdit = false, preset = null) {
            const modal = document.getElementById('timer-preset-modal');
            const title = document.getElementById('timer-modal-title');
            const nameInput = document.getElementById('timer-preset-name-input');
            const emojiInput = document.getElementById('timer-preset-emoji-input');
            const minutesInput = document.getElementById('timer-preset-minutes-input');
            const secondsInput = document.getElementById('timer-preset-seconds-input');
            const saveBtn = document.getElementById('timer-save-btn');
            
            appState.editingTimerPreset = preset;
            
            if (isEdit && preset) {
                title.textContent = 'タイマープリセット編集';
                nameInput.value = preset.name;
                emojiInput.value = preset.emoji;
                minutesInput.value = preset.minutes;
                secondsInput.value = preset.seconds;
                saveBtn.textContent = '更新';
            } else {
                title.textContent = 'タイマープリセット追加';
                nameInput.value = '';
                emojiInput.value = '⏰';
                minutesInput.value = '25';
                secondsInput.value = '0';
                saveBtn.textContent = '追加';
            }
            
            modal.classList.remove('hidden');
            nameInput.focus();
        }

        function closeTimerPresetModal() {
            document.getElementById('timer-preset-modal').classList.add('hidden');
            appState.editingTimerPreset = null;
        }

        function saveTimerPreset() {
            const nameInput = document.getElementById('timer-preset-name-input');
            const emojiInput = document.getElementById('timer-preset-emoji-input');
            const minutesInput = document.getElementById('timer-preset-minutes-input');
            const secondsInput = document.getElementById('timer-preset-seconds-input');
            
            const name = nameInput.value.trim();
            const emoji = emojiInput.value.trim() || '⏰';
            const minutes = parseInt(minutesInput.value) || 0;
            const seconds = parseInt(secondsInput.value) || 0;
            
            if (!name) {
                alert('プリセット名を入力してください');
                return;
            }
            
            if (minutes === 0 && seconds === 0) {
                alert('時間を設定してください');
                return;
            }
            
            if (appState.editingTimerPreset) {
                // 編集
                const index = appState.timerPresets.findIndex(p => p.id === appState.editingTimerPreset.id);
                if (index !== -1) {
                    appState.timerPresets[index] = { ...appState.timerPresets[index], name, emoji, minutes, seconds };
                }
            } else {
                // 新規追加
                const newPreset = {
                    id: Date.now(),
                    name,
                    emoji,
                    minutes,
                    seconds
                };
                appState.timerPresets.push(newPreset);
            }
            
            updateTimerPresetGrid();
            updateTimerPresetList();
            closeTimerPresetModal();
            saveTimerPresetsToStorage();
        }

        function editTimerPreset(id) {
            const preset = appState.timerPresets.find(p => p.id === id);
            if (preset) {
                openTimerPresetModal(true, preset);
            }
        }

        function deleteTimerPreset(id) {
            if (appState.timerPresets.length <= 1) {
                alert('最低1つのプリセットが必要です');
                return;
            }
            
            if (confirm('このプリセットを削除しますか？')) {
                appState.timerPresets = appState.timerPresets.filter(p => p.id !== id);
                
                if (appState.selectedTimerPreset?.id === id) {
                    appState.selectedTimerPreset = null;
                    appState.timerRemaining = 0;
                    updateTimerDisplay();
                }
                
                updateTimerPresetGrid();
                updateTimerPresetList();
                saveTimerPresetsToStorage();
            }
        }

        function saveTimerPresetsToStorage() {
            localStorage.setItem('taptime-timer-presets', JSON.stringify(appState.timerPresets));
        }

        function loadTimerPresetsFromStorage() {
            const saved = localStorage.getItem('taptime-timer-presets');
            if (saved) {
                try {
                    appState.timerPresets = JSON.parse(saved);
                } catch (e) {
                    console.error('Failed to load timer presets:', e);
                }
            }
        }

        // アラーム音設定の保存と適用
        function setAlarmSound(soundId) {
            appState.alarmSound = soundId;
            localStorage.setItem('taptime-alarm-sound', soundId);
            
            // オプションの表示更新
            document.querySelectorAll('#alarm-sound-options .background-option').forEach(option => {
                option.classList.toggle('active', option.dataset.sound === soundId);
            });
        }

        // カスタムアラーム音の追加
        function addCustomAlarmSound(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const customSound = {
                    id: 'custom-alarm-' + Date.now(),
                    name: file.name,
                    url: e.target.result
                };
                
                appState.customAlarmSounds.push(customSound);
                localStorage.setItem('taptime-custom-alarm-sounds', JSON.stringify(appState.customAlarmSounds));
                
                updateAlarmSoundOptions();
                setAlarmSound(customSound.id);
            };
            reader.readAsDataURL(file);
        }

        // アラーム音オプションの更新
        function updateAlarmSoundOptions() {
            const container = document.getElementById('alarm-sound-options');
            if (!container) return;
            
            let html = `
                <div class="background-option ${appState.alarmSound === 'default' ? 'active' : ''}" data-sound="default">
                    <div class="background-preview" style="background: linear-gradient(45deg, #3b82f6, #8b5cf6); display: flex; align-items: center; justify-content: center; font-size: 2rem;">
                        🔔
                    </div>
                    <div class="background-label">デフォルト</div>
                </div>
            `;
            
            // カスタムアラーム音を追加
            appState.customAlarmSounds.forEach(sound => {
                const isActive = appState.alarmSound === sound.id;
                html += `
                    <div class="background-option ${isActive ? 'active' : ''}" data-sound="${sound.id}">
                        <div class="background-preview" style="background: linear-gradient(45deg, #ec4899, #f59e0b); display: flex; align-items: center; justify-content: center; font-size: 2rem;">
                            🎵
                        </div>
                        <div class="background-label">${sound.name}</div>
                        <button class="action-btn" style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.5); color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px;" onclick="removeCustomAlarmSound('${sound.id}')">×</button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // イベントリスナーを追加
            container.querySelectorAll('.background-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('action-btn')) {
                        setAlarmSound(option.dataset.sound);
                    }
                });
            });
        }

        // カスタムアラーム音の削除
        function removeCustomAlarmSound(soundId) {
            if (confirm('このアラーム音を削除しますか？')) {
                appState.customAlarmSounds = appState.customAlarmSounds.filter(s => s.id !== soundId);
                localStorage.setItem('taptime-custom-alarm-sounds', JSON.stringify(appState.customAlarmSounds));
                
                if (appState.alarmSound === soundId) {
                    setAlarmSound('default');
                }
                
                updateAlarmSoundOptions();
            }
        }

        // アラーム音のテスト
        function testAlarmSound() {
            // 既存の音を停止
            stopAlarmSound();
            
            // テスト用に一時的にアラームを再生
            appState.alarmPlayed = false;
            playAlarmSound();
            
            // 3秒後に自動停止
            setTimeout(() => {
                stopAlarmSound();
            }, 3000);
        }

        // テーマ設定の保存と適用
        function setTheme(theme) {
            appState.currentTheme = theme;
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('taptime-theme', theme);
            
            // テーマオプションの表示更新
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.toggle('active', option.dataset.theme === theme);
            });
        }

        // フォント設定の保存と適用
        function setFont(font) {
            appState.currentFont = font;
            document.body.setAttribute('data-font', font);
            localStorage.setItem('taptime-font', font);
            
            // フォントオプションの表示更新
            document.querySelectorAll('.font-option').forEach(option => {
                option.classList.toggle('active', option.dataset.font === font);
            });
        }

        // 背景設定の保存と適用
        function setBackground(backgroundId) {
            appState.currentBackground = backgroundId;
            localStorage.setItem('taptime-background', backgroundId);
            
            const container = document.getElementById('background-container');
            container.innerHTML = '';
            
            if (backgroundId === 'none') {
                container.classList.remove('active');
                return;
            }
            
            // カスタム背景の確認
            const customBg = appState.customBackgrounds.find(bg => bg.id === backgroundId);
            if (customBg) {
                if (customBg.type === 'video') {
                    const video = document.createElement('video');
                    video.className = 'background-video';
                    video.src = customBg.url;
                    video.autoplay = true;
                    video.loop = true;
                    video.muted = true;
                    video.playsInline = true;
                    container.appendChild(video);
                } else {
                    const img = document.createElement('div');
                    img.className = 'background-image';
                    img.style.backgroundImage = `url(${customBg.url})`;
                    container.appendChild(img);
                }
            } else {
                // プリセット背景
                const presetBg = presetBackgrounds.find(bg => bg.id === backgroundId);
                if (presetBg) {
                    const bgElement = document.createElement('div');
                    bgElement.className = 'background-svg';
                    bgElement.style.backgroundImage = `url('${presetBg.url}')`;
                    container.appendChild(bgElement);
                }
            }
            
            container.classList.add('active');
            
            // 背景オプションの表示更新
            document.querySelectorAll('.background-option').forEach(option => {
                option.classList.toggle('active', option.dataset.bg === backgroundId);
            });
        }

        // カスタム背景の追加
        function addCustomBackground(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const customBg = {
                    id: 'custom-' + Date.now(),
                    name: file.name,
                    type: file.type.startsWith('video/') ? 'video' : 'image',
                    url: e.target.result
                };
                
                appState.customBackgrounds.push(customBg);
                localStorage.setItem('taptime-custom-backgrounds', JSON.stringify(appState.customBackgrounds));
                
                updateBackgroundOptions();
                setBackground(customBg.id);
            };
            reader.readAsDataURL(file);
        }

        // 背景オプションの更新
        function updateBackgroundOptions() {
            const container = document.getElementById('background-options');
            let html = `
                <div class="background-option ${appState.currentBackground === 'none' ? 'active' : ''}" data-bg="none">
                    <div class="background-preview" style="background: linear-gradient(45deg, #f0f9ff, #e0e7ff);"></div>
                    <div class="background-label">なし</div>
                </div>
            `;
            
            // プリセット背景を追加
            presetBackgrounds.forEach(bg => {
                const isActive = appState.currentBackground === bg.id;
                html += `
                    <div class="background-option ${isActive ? 'active' : ''}" data-bg="${bg.id}">
                        <div class="background-preview" style="background-image: url('${bg.url}'); background-size: cover; background-position: center;"></div>
                        <div class="background-label">${bg.name}</div>
                    </div>
                `;
            });
            
            // カスタム背景を追加
            appState.customBackgrounds.forEach(bg => {
                const isActive = appState.currentBackground === bg.id;
                html += `
                    <div class="background-option ${isActive ? 'active' : ''}" data-bg="${bg.id}">
                        <div class="background-preview" style="background-image: url('${bg.url}'); background-size: cover; background-position: center;"></div>
                        <div class="background-label">${bg.name}</div>
                        <button class="action-btn" style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.5); color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px;" onclick="removeCustomBackground('${bg.id}')">×</button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // イベントリスナーを追加
            container.querySelectorAll('.background-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('action-btn')) {
                        setBackground(option.dataset.bg);
                    }
                });
            });
        }

        // 没入モードの制御
        function enterImmersiveMode() {
            document.body.classList.add('immersive-mode');
            
            // 現在の画面に応じたオーバーレイを表示
            if (appState.activeScreen === 'record') {
                document.getElementById('immersive-overlay').style.display = 'block';
            } else if (appState.activeScreen === 'timer') {
                document.getElementById('timer-immersive-overlay').style.display = 'block';
            }
        }

        function exitImmersiveMode() {
            document.body.classList.remove('immersive-mode');
            document.getElementById('immersive-overlay').style.display = 'none';
            document.getElementById('timer-immersive-overlay').style.display = 'none';
        }

        // 没入モードタイマーの設定
        function setImmersiveTimer() {
            if (appState.immersiveTimeout) {
                clearTimeout(appState.immersiveTimeout);
            }
            
            if (appState.isRecording && appState.activeScreen === 'record') {
                appState.immersiveTimeout = setTimeout(() => {
                    if (appState.isRecording && appState.activeScreen === 'record') {
                        enterImmersiveMode();
                    }
                }, 5000);
            }
        }

        // 没入モードタイマーのクリア
        function clearImmersiveTimer() {
            if (appState.immersiveTimeout) {
                clearTimeout(appState.immersiveTimeout);
                appState.immersiveTimeout = null;
            }
            if (appState.activeScreen === 'record') {
                exitImmersiveMode();
            }
        }

        // ページの表示状態変更を監視
        function handleVisibilityChange() {
            if (document.hidden) {
                if (appState.immersiveTimeout) {
                    clearTimeout(appState.immersiveTimeout);
                    appState.immersiveTimeout = null;
                }
                if (appState.timerImmersiveTimeout) {
                    clearTimeout(appState.timerImmersiveTimeout);
                    appState.timerImmersiveTimeout = null;
                }
                exitImmersiveMode();
            }
        }

        // カスタム背景の削除
        function removeCustomBackground(bgId) {
            if (confirm('この背景を削除しますか？')) {
                appState.customBackgrounds = appState.customBackgrounds.filter(bg => bg.id !== bgId);
                localStorage.setItem('taptime-custom-backgrounds', JSON.stringify(appState.customBackgrounds));
                
                if (appState.currentBackground === bgId) {
                    setBackground('none');
                }
                
                updateBackgroundOptions();
            }
        }

        // ユーティリティ関数
        function formatTime(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            return `${hours.toString().padStart(2, '0')}:${(minutes % 60).toString().padStart(2, '0')}:${(seconds % 60).toString().padStart(2, '0')}`;
        }

        function getCategoryById(id) {
            return appState.categories.find(cat => cat.id === id);
        }

        function updateCurrentTime() {
            appState.currentTime = new Date();
            const currentTimeEl = document.getElementById('current-time');
            if (currentTimeEl) {
                currentTimeEl.textContent = appState.currentTime.toLocaleTimeString('ja-JP');
            }
            
            if (appState.isRecording && appState.recordingStart) {
                appState.elapsedTime = Date.now() - appState.recordingStart;
                const elapsedTimeEl = document.getElementById('elapsed-time');
                if (elapsedTimeEl) {
                    elapsedTimeEl.textContent = formatTime(appState.elapsedTime);
                }
            }
        }

        function updateCategoryDropdown() {
            const dropdown = document.getElementById('category-dropdown');
            const selectedDisplay = document.getElementById('selected-category');
            
            if (!dropdown || !selectedDisplay) return;
            
            // 選択中のカテゴリ表示を更新
            const selectedCategory = getCategoryById(appState.selectedCategory);
            if (selectedCategory) {
                selectedDisplay.innerHTML = `
                    <span class="color-dot" style="background-color: ${selectedCategory.color};"></span>
                    <span>${selectedCategory.name}</span>
                `;
            }

            // ドロップダウンオプションを更新
            dropdown.innerHTML = '';
            appState.categories.forEach(category => {
                const item = document.createElement('button');
                item.className = 'dropdown-item';
                item.innerHTML = `
                    <span class="color-dot" style="background-color: ${category.color};"></span>
                    <span>${category.name}</span>
                `;
                item.addEventListener('click', () => {
                    appState.selectedCategory = category.id;
                    updateCategoryDropdown();
                    updateRecordingStatus();
                    dropdown.classList.add('hidden');
                });
                dropdown.appendChild(item);
            });
        }

        function updateRecordingStatus() {
            const status = document.getElementById('recording-status');
            const mainButton = document.getElementById('main-button');
            const dropdownBtn = document.getElementById('category-dropdown-btn');
            
            if (!status || !mainButton || !dropdownBtn) return;
            
            if (appState.isRecording) {
                const category = getCategoryById(appState.selectedCategory);
                status.innerHTML = `
                    <span class="color-dot" style="background-color: ${category.color};"></span>
                    <span class="recording-status-text">${category.name} を記録中...</span>
                `;
                status.classList.remove('hidden');
                mainButton.className = 'main-button stop';
                mainButton.innerHTML = '<span>⏸</span><span>停止</span>';
                dropdownBtn.disabled = true;
            } else {
                status.classList.add('hidden');
                mainButton.className = 'main-button start';
                mainButton.innerHTML = '<span>▶</span><span>開始</span>';
                dropdownBtn.disabled = false;
            }
        }

        function toggleRecording() {
            if (!appState.selectedCategory) {
                alert('カテゴリを選択してください');
                return;
            }

            if (appState.isRecording) {
                // 記録停止
                const endTime = Date.now();
                const duration = endTime - appState.recordingStart;
                const newRecord = {
                    id: Date.now(),
                    categoryId: appState.selectedCategory,
                    startTime: appState.recordingStart,
                    endTime: endTime,
                    duration: duration,
                    date: new Date(appState.recordingStart).toDateString()
                };
                appState.records.push(newRecord);
                appState.isRecording = false;
                appState.recordingStart = null;
                appState.elapsedTime = 0;
                document.getElementById('elapsed-time').textContent = '00:00:00';
                
                clearImmersiveTimer();
            } else {
                // 記録開始
                appState.recordingStart = Date.now();
                appState.isRecording = true;
                appState.elapsedTime = 0;
                
                setImmersiveTimer();
            }
            
            updateRecordingStatus();
        }

        function switchScreen(screenName) {
            // 全画面を非表示
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // ナビゲーションアイテムの状態更新
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 選択された画面を表示
            document.getElementById(`${screenName}-screen`).classList.add('active');
            document.querySelector(`[data-screen="${screenName}"]`).classList.add('active');
            
            appState.activeScreen = screenName;
            
            // 画面切り替え時に没入モードを終了
            if (screenName !== 'record') {
                clearImmersiveTimer();
            } else if (screenName === 'record' && appState.isRecording) {
                setImmersiveTimer();
            }
            
            if (screenName !== 'timer') {
                clearTimerImmersiveTimer();
            } else if (screenName === 'timer' && appState.timerState === 'running') {
                setTimerImmersiveTimer();
            }
            
            // 画面固有の更新処理
            if (screenName === 'stats') {
                if (appState.showingDetailView) {
                    showDetailView(appState.detailViewDate);
                } else {
                    showCalendarView();
                }
            } else if (screenName === 'settings') {
                updateSettingsScreen();
            // タイマー画面の初期化
            } else if (screenName === 'timer') {
                updateTimerDisplay();
                updateTimerPresetGrid();
                updateTimerControls(); // ボタンの状態を確実に更新
            }
        }

        // カレンダービューの表示
        function showCalendarView() {
            appState.showingDetailView = false;
            document.getElementById('calendar-view').style.display = 'block';
            document.getElementById('detail-view').classList.remove('active');
            updateCalendar();
        }

        // 詳細ビューの表示
        function showDetailView(date) {
            appState.showingDetailView = true;
            appState.detailViewDate = date;
            document.getElementById('calendar-view').style.display = 'none';
            document.getElementById('detail-view').classList.add('active');
            document.getElementById('detail-date').textContent = date.toLocaleDateString('ja-JP');
            updateDetailView(date);
        }

        // カレンダーの更新
        function updateCalendar() {
            const monthYear = document.getElementById('current-month');
            const calendarGrid = document.getElementById('calendar-grid');
            
            const year = appState.calendarDate.getFullYear();
            const month = appState.calendarDate.getMonth();
            
            monthYear.textContent = `${year}年${month + 1}月`;
            
            // カレンダーグリッドをクリア
            calendarGrid.innerHTML = '';
            
            // 曜日ヘッダー
            const dayHeaders = ['日', '月', '火', '水', '木', '金', '土'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            // 月の最初の日と最後の日
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            // 6週間分の日付を生成
            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                const isCurrentMonth = currentDate.getMonth() === month;
                const isToday = currentDate.toDateString() === new Date().toDateString();
                const dateStr = currentDate.toDateString();
                
                // その日の記録を取得
                const dayRecords = appState.records.filter(record => record.date === dateStr);
                const totalTime = dayRecords.reduce((sum, record) => sum + record.duration, 0);
                const hasRecords = dayRecords.length > 0;
                
                if (!isCurrentMonth) {
                    dayElement.classList.add('other-month');
                }
                if (isToday) {
                    dayElement.classList.add('today');
                }
                if (hasRecords) {
                    dayElement.classList.add('has-records');
                }
                
                dayElement.innerHTML = `
                    <div class="day-number">${currentDate.getDate()}</div>
                    ${hasRecords ? `<div class="day-total">${formatTime(totalTime)}</div>` : ''}
                `;
                
                // クリックイベント
                if (isCurrentMonth) {
                    dayElement.addEventListener('click', () => {
                        showDetailView(new Date(currentDate));
                    });
                }
                
                calendarGrid.appendChild(dayElement);
            }
        }

        // 詳細ビューの更新
        function updateDetailView(date) {
            const dateStr = date.toDateString();
            const dayRecords = appState.records.filter(record => record.date === dateStr);
            
            // カテゴリ別統計
            const categoryStats = {};
            let totalTime = 0;
            
            dayRecords.forEach(record => {
                const category = getCategoryById(record.categoryId);
                if (category) {
                    if (!categoryStats[category.name]) {
                        categoryStats[category.name] = { time: 0, color: category.color };
                    }
                    categoryStats[category.name].time += record.duration;
                    totalTime += record.duration;
                }
            });
            
            // 統計表示
            const statsContainer = document.getElementById('detail-category-stats');
            if (Object.keys(categoryStats).length === 0) {
                statsContainer.innerHTML = '<div class="no-records">この日の記録はありません</div>';
            } else {
                let html = '';
                Object.entries(categoryStats).forEach(([name, data]) => {
                    const percentage = totalTime > 0 ? (data.time / totalTime * 100) : 0;
                    html += `
                        <div class="stat-item">
                            <div class="stat-header">
                                <div class="stat-name">
                                    <span class="color-dot" style="background-color: ${data.color};"></span>
                                    <span>${name}</span>
                                </div>
                                <div class="stat-value">${formatTime(data.time)} (${percentage.toFixed(1)}%)</div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="background-color: ${data.color}; width: ${percentage}%;"></div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                    <div style="padding-top: 20px; border-top: 1px solid var(--border-color); margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; font-weight: bold;">
                            <span>合計時間</span>
                            <span>${formatTime(totalTime)}</span>
                        </div>
                    </div>
                `;
                statsContainer.innerHTML = html;
            }
            
            // 記録一覧
            const recordList = document.getElementById('detail-record-list');
            if (dayRecords.length === 0) {
                recordList.innerHTML = '<div class="no-records">この日の記録はありません</div>';
            } else {
                let html = '';
                dayRecords.sort((a, b) => b.startTime - a.startTime).forEach(record => {
                    const category = getCategoryById(record.categoryId);
                    const noteText = record.note ? ` (${record.note})` : '';
                    html += `
                        <div class="record-item">
                            <div class="record-info">
                                <span class="color-dot" style="background-color: ${category.color};"></span>
                                <div class="record-details">
                                    <div class="record-category">${category.name}${noteText}</div>
                                    <div class="record-time">
                                        ${new Date(record.startTime).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })} - 
                                        ${new Date(record.endTime).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })}
                                    </div>
                                </div>
                            </div>
                            <div class="record-duration">${formatTime(record.duration)}</div>
                        </div>
                    `;
                });
                recordList.innerHTML = html;
            }
        }

        function updateStatsScreen() {
            if (appState.showingDetailView) {
                showDetailView(appState.detailViewDate);
            } else {
                showCalendarView();
            }
        }

        function updateSettingsScreen() {
            const categoryList = document.getElementById('category-list');
            let html = '';
            
            appState.categories.forEach(category => {
                html += `
                    <div class="category-item">
                        <div class="category-info">
                            <span class="color-dot" style="background-color: ${category.color};"></span>
                            <span class="category-name">${category.name}</span>
                        </div>
                        <div class="category-actions">
                            <button class="action-btn" onclick="editCategory(${category.id})">✏️</button>
                            <button class="action-btn" onclick="deleteCategory(${category.id})" ${appState.categories.length <= 1 ? 'disabled' : ''}>🗑️</button>
                        </div>
                    </div>
                `;
            });
            
            categoryList.innerHTML = html;
            updateBackgroundOptions();
            updateAlarmSoundOptions();
            updateTimerPresetList();
        }

        function openModal(isEdit = false, category = null) {
            const modal = document.getElementById('category-modal');
            const title = document.getElementById('modal-title');
            const nameInput = document.getElementById('category-name-input');
            const colorPicker = document.getElementById('color-picker');
            const colorInput = document.getElementById('color-input');
            const saveBtn = document.getElementById('save-btn');
            
            appState.editingCategory = category;
            
            if (isEdit && category) {
                title.textContent = 'カテゴリ編集';
                nameInput.value = category.name;
                colorPicker.value = category.color;
                colorInput.value = category.color;
                saveBtn.textContent = '更新';
            } else {
                title.textContent = 'カテゴリ追加';
                nameInput.value = '';
                colorPicker.value = '#3b82f6';
                colorInput.value = '#3b82f6';
                saveBtn.textContent = '追加';
            }
            
            updateColorPalette();
            modal.classList.remove('hidden');
            nameInput.focus();
        }

        function closeModal() {
            document.getElementById('category-modal').classList.add('hidden');
            appState.editingCategory = null;
        }

        function updateColorPalette() {
            const palette = document.getElementById('color-palette');
            const currentColor = document.getElementById('color-picker').value;
            
            let html = '';
            presetColors.forEach(color => {
                const selected = color === currentColor ? 'selected' : '';
                html += `<div class="color-swatch ${selected}" style="background-color: ${color};" onclick="selectColor('${color}')"></div>`;
            });
            palette.innerHTML = html;
        }

        function selectColor(color) {
            document.getElementById('color-picker').value = color;
            document.getElementById('color-input').value = color;
            updateColorPalette();
        }

        function saveCategory() {
            const nameInput = document.getElementById('category-name-input');
            const colorInput = document.getElementById('color-input');
            
            const name = nameInput.value.trim();
            const color = colorInput.value;
            
            if (!name) {
                alert('カテゴリ名を入力してください');
                return;
            }
            
            if (appState.editingCategory) {
                // 編集
                const index = appState.categories.findIndex(cat => cat.id === appState.editingCategory.id);
                if (index !== -1) {
                    appState.categories[index] = { ...appState.categories[index], name, color };
                }
            } else {
                // 新規追加
                const newCategory = {
                    id: Date.now(),
                    name,
                    color
                };
                appState.categories.push(newCategory);
            }
            
            updateCategoryDropdown();
            updateSettingsScreen();
            closeModal();
        }

        function editCategory(id) {
            const category = getCategoryById(id);
            if (category) {
                openModal(true, category);
            }
        }

        function deleteCategory(id) {
            if (appState.categories.length <= 1) {
                alert('最低1つのカテゴリが必要です');
                return;
            }
            
            if (confirm('このカテゴリを削除しますか？')) {
                appState.categories = appState.categories.filter(cat => cat.id !== id);
                
                // 選択中のカテゴリが削除された場合、最初のカテゴリを選択
                if (appState.selectedCategory === id) {
                    appState.selectedCategory = appState.categories[0].id;
                }
                
                updateCategoryDropdown();
                updateSettingsScreen();
            }
        }

        function exportData() {
            if (appState.records.length === 0) {
                alert('エクスポートするデータがありません');
                return;
            }
            
            const headers = ['日付', 'カテゴリ', '開始時間', '終了時間', '時間(分)'];
            const rows = appState.records.map(record => {
                const category = getCategoryById(record.categoryId);
                return [
                    new Date(record.startTime).toLocaleDateString('ja-JP'),
                    category?.name || 'Unknown',
                    new Date(record.startTime).toLocaleTimeString('ja-JP'),
                    new Date(record.endTime).toLocaleTimeString('ja-JP'),
                    Math.round(record.duration / 60000)
                ];
            });
            
            const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'taptime_data.csv';
            link.click();
        }

        function importData() {
            const input = document.getElementById('import-input');
            input.click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    const lines = csvText.split('\n');
                    
                    if (lines.length < 2) {
                        alert('CSVファイルが空または無効です');
                        return;
                    }

                    const headers = lines[0].split(',');
                    const expectedHeaders = ['日付', 'カテゴリ', '開始時間', '終了時間', '時間(分)'];
                    
                    // ヘッダーチェック（柔軟に対応）
                    const hasValidHeaders = expectedHeaders.some(header => 
                        headers.some(h => h.trim().includes(header) || h.trim().includes(header.replace('(分)', '')))
                    );
                    
                    if (!hasValidHeaders) {
                        alert('CSVファイルの形式が正しくありません。\n期待されるヘッダー: 日付, カテゴリ, 開始時間, 終了時間, 時間(分)');
                        return;
                    }

                    let importedCount = 0;
                    let skippedCount = 0;
                    const newRecords = [];

                    // データ行を処理
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        const columns = line.split(',');
                        if (columns.length < 4) continue;

                        try {
                            const dateStr = columns[0].trim();
                            const categoryName = columns[1].trim();
                            const startTimeStr = columns[2].trim();
                            const endTimeStr = columns[3].trim();

                            // 日付と時間をパース
                            const startDateTime = new Date(`${dateStr} ${startTimeStr}`);
                            const endDateTime = new Date(`${dateStr} ${endTimeStr}`);

                            if (isNaN(startDateTime.getTime()) || isNaN(endDateTime.getTime())) {
                                skippedCount++;
                                continue;
                            }

                            // カテゴリを検索または作成
                            let category = appState.categories.find(cat => cat.name === categoryName);
                            if (!category) {
                                // 新しいカテゴリを作成
                                const colors = ['#3b82f6', '#10b981', '#8b5cf6', '#f59e0b', '#ef4444', '#06b6d4', '#84cc16', '#f97316'];
                                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                                category = {
                                    id: Date.now() + Math.random(),
                                    name: categoryName,
                                    color: randomColor
                                };
                                appState.categories.push(category);
                            }

                            // 記録を作成
                            const duration = endDateTime.getTime() - startDateTime.getTime();
                            if (duration > 0) {
                                const newRecord = {
                                    id: Date.now() + Math.random(),
                                    categoryId: category.id,
                                    startTime: startDateTime.getTime(),
                                    endTime: endDateTime.getTime(),
                                    duration: duration,
                                    date: startDateTime.toDateString()
                                };
                                newRecords.push(newRecord);
                                importedCount++;
                            } else {
                                skippedCount++;
                            }
                        } catch (error) {
                            skippedCount++;
                        }
                    }

                    // データを追加
                    appState.records.push(...newRecords);
                    updateCategoryDropdown();
                    updateSettingsScreen();

                    // 結果を表示
                    if (importedCount > 0) {
                        alert(`インポート完了！\n成功: ${importedCount}件\nスキップ: ${skippedCount}件`);
                    } else {
                        alert('有効なデータが見つかりませんでした。\nファイル形式を確認してください。');
                    }

                } catch (error) {
                    alert('ファイルの読み込みに失敗しました。\nCSVファイルを確認してください。');
                    console.error('Import error:', error);
                }
            };
            
            reader.readAsText(file, 'UTF-8');
            // ファイル選択をリセット
            event.target.value = '';
        }

        // イベントリスナーの設定
        function setupEventListeners() {
            // タイマー更新
            setInterval(updateCurrentTime, 1000);
            
            // メインボタン
            document.getElementById('main-button').addEventListener('click', toggleRecording);
            
            // カテゴリドロップダウン
            document.getElementById('category-dropdown-btn').addEventListener('click', () => {
                const dropdown = document.getElementById('category-dropdown');
                dropdown.classList.toggle('hidden');
            });
            
            // ドロップダウン外クリックで閉じる
            document.addEventListener('click', (e) => {
                const dropdown = document.getElementById('category-dropdown');
                const dropdownBtn = document.getElementById('category-dropdown-btn');
                if (!dropdown.contains(e.target) && !dropdownBtn.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });
            
            // ナビゲーション
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const screen = item.dataset.screen;
                    switchScreen(screen);
                });
            });
            
            // 統計画面のナビゲーション
            document.getElementById('prev-month').addEventListener('click', () => {
                appState.calendarDate = new Date(appState.calendarDate.getFullYear(), appState.calendarDate.getMonth() - 1, 1);
                updateCalendar();
            });
            
            document.getElementById('next-month').addEventListener('click', () => {
                appState.calendarDate = new Date(appState.calendarDate.getFullYear(), appState.calendarDate.getMonth() + 1, 1);
                updateCalendar();
            });

            // 戻るボタンのイベントリスナー
            const backButton = document.getElementById('back-to-calendar');
            if (backButton) {
                backButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    showCalendarView();
                });
            }
            
            // テーマ選択
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', () => {
                    setTheme(option.dataset.theme);
                });
            });

            // フォント選択
            document.querySelectorAll('.font-option').forEach(option => {
                option.addEventListener('click', () => {
                    setFont(option.dataset.font);
                });
            });

            // カスタム背景ファイル選択
            document.getElementById('custom-background').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    addCustomBackground(file);
                }
            });

            // カスタムアラーム音ファイル選択
            document.getElementById('custom-alarm-sound').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    console.log('Selected audio file:', file.name, file.type, file.size);
                    addCustomAlarmSound(file);
                }
            });

            // アラーム音テストボタン
            document.getElementById('test-alarm-btn').addEventListener('click', testAlarmSound);

            // 没入モードオーバーレイクリック（記録画面）
            document.getElementById('immersive-overlay').addEventListener('click', (e) => {
                exitImmersiveMode();
                if (appState.isRecording) {
                    setImmersiveTimer();
                }
            });
            
            // 没入モードオーバーレイクリック（タイマー画面）
            document.getElementById('timer-immersive-overlay').addEventListener('click', (e) => {
                exitImmersiveMode();
                if (appState.timerState === 'running') {
                    setTimerImmersiveTimer();
                }
            });
            
            // ページの表示状態変更を監視（タブ切り替え対応）
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            // タイマーコントロール - 初期設定のみ
            document.getElementById('timer-reset-btn').addEventListener('click', resetTimer);
            
            // 初期状態でタイマーコントロールを設定
            updateTimerControls();
            
            // 設定画面のボタン
            document.getElementById('add-category-btn').addEventListener('click', () => openModal());
            document.getElementById('add-timer-preset-btn').addEventListener('click', () => openTimerPresetModal());
            document.getElementById('export-btn').addEventListener('click', exportData);
            document.getElementById('import-btn').addEventListener('click', importData);
            document.getElementById('import-input').addEventListener('change', handleFileImport);
            
            // カテゴリモーダルのボタン
            document.getElementById('cancel-btn').addEventListener('click', closeModal);
            document.getElementById('save-btn').addEventListener('click', saveCategory);
            
            // タイマープリセットモーダルのボタン
            document.getElementById('timer-cancel-btn').addEventListener('click', closeTimerPresetModal);
            document.getElementById('timer-save-btn').addEventListener('click', saveTimerPreset);
            
            // カラーピッカーの同期
            document.getElementById('color-picker').addEventListener('change', (e) => {
                document.getElementById('color-input').value = e.target.value;
                updateColorPalette();
            });
            
            document.getElementById('color-input').addEventListener('input', (e) => {
                const color = e.target.value;
                if (/^#[0-9A-Fa-f]{6}$/.test(color)) {
                    document.getElementById('color-picker').value = color;
                    updateColorPalette();
                }
            });
            
            // カテゴリ名入力でのEnterキー
            document.getElementById('category-name-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    saveCategory();
                } else if (e.key === 'Escape') {
                    closeModal();
                }
            });
            
            // タイマープリセット名入力でのEnterキー
            document.getElementById('timer-preset-name-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    saveTimerPreset();
                } else if (e.key === 'Escape') {
                    closeTimerPresetModal();
                }
            });
            
            // モーダル背景クリックで閉じる
            document.getElementById('category-modal').addEventListener('click', (e) => {
                if (e.target.id === 'category-modal') {
                    closeModal();
                }
            });
            
            document.getElementById('timer-preset-modal').addEventListener('click', (e) => {
                if (e.target.id === 'timer-preset-modal') {
                    closeTimerPresetModal();
                }
            });
            
            // PWA用のキーボードショートカット
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + Space でタイマー/記録の開始/停止
                if ((e.ctrlKey || e.metaKey) && e.code === 'Space') {
                    e.preventDefault();
                    if (appState.activeScreen === 'record') {
                        toggleRecording();
                    } else if (appState.activeScreen === 'timer') {
                        if (appState.timerState === 'idle') {
                            startTimer();
                        } else if (appState.timerState === 'running') {
                            pauseTimer();
                        } else if (appState.timerState === 'paused') {
                            resumeTimer();
                        }
                    }
                }
                
                // Ctrl/Cmd + 1,2,3,4 で画面切り替え
                if ((e.ctrlKey || e.metaKey) && e.key >= '1' && e.key <= '4') {
                    e.preventDefault();
                    const screens = ['record', 'timer', 'stats', 'settings'];
                    switchScreen(screens[parseInt(e.key) - 1]);
                }
            });
        }

        // グローバル関数として定義（onclick属性から呼び出すため）
        window.startTimer = startTimer;
        window.pauseTimer = pauseTimer;
        window.resumeTimer = resumeTimer;
        window.resetTimer = resetTimer;
        window.setCustomTime = setCustomTime;
        window.selectTimerPreset = selectTimerPreset;
        window.editTimerPreset = editTimerPreset;
        window.deleteTimerPreset = deleteTimerPreset;
        window.editCategory = editCategory;
        window.deleteCategory = deleteCategory;
        window.selectColor = selectColor;
        window.removeCustomBackground = removeCustomBackground;
        window.removeCustomAlarmSound = removeCustomAlarmSound;
        window.closeTimerCompleteModal = closeTimerCompleteModal;
        window.stopAlarmSound = stopAlarmSound;
        function initApp() {
            // 保存された設定を適用
            setTheme(appState.currentTheme);
            setFont(appState.currentFont);
            setBackground(appState.currentBackground);
            
            loadTimerPresetsFromStorage();
            
            updateCurrentTime();
            updateCategoryDropdown();
            updateRecordingStatus();
            updateTimerDisplay();
            updateTimerControls();
            setupEventListeners();
            
            // PWA用のサービスワーカー登録
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:text/javascript,');
            }
            
            // PWAインストールプロンプト
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                setTimeout(() => {
                    if (confirm('TapTimeをホーム画面に追加しますか？アプリのように使用できます。')) {
                        e.prompt();
                    }
                }, 10000); // 10秒後に表示
            });
        }

        // ページ読み込み完了時に初期化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        // ページ離脱時にデータを保存
        window.addEventListener('beforeunload', () => {
            localStorage.setItem('taptime-categories', JSON.stringify(appState.categories));
            localStorage.setItem('taptime-records', JSON.stringify(appState.records));
            localStorage.setItem('taptime-selected-category', appState.selectedCategory.toString());
            saveTimerPresetsToStorage();
        });

        // ページ読み込み時にデータを復元
        window.addEventListener('load', () => {
            try {
                const savedCategories = localStorage.getItem('taptime-categories');
                const savedRecords = localStorage.getItem('taptime-records');
                const savedSelectedCategory = localStorage.getItem('taptime-selected-category');
                
                if (savedCategories) {
                    const categories = JSON.parse(savedCategories);
                    // タイマー集中カテゴリが存在することを確認
                    if (!categories.find(cat => cat.name === 'タイマー集中')) {
                        categories.push({
                            id: 'timer-category-default',
                            name: 'タイマー集中',
                            color: '#ec4899'
                        });
                    }
                    appState.categories = categories;
                }
                
                if (savedRecords) {
                    appState.records = JSON.parse(savedRecords);
                    console.log('Loaded records:', appState.records.length);
                }
                
                if (savedSelectedCategory) {
                    appState.selectedCategory = parseInt(savedSelectedCategory) || appState.categories[0].id;
                }
                
                updateCategoryDropdown();
                // 統計画面が表示されている場合は更新
                if (appState.activeScreen === 'stats') {
                    updateCalendar();
                }
            } catch (error) {
                console.warn('データの復元に失敗しました:', error);
            }
        });
    </script>
</body>
</html>